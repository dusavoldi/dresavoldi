<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Evolução Médica</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --highlight-color: rgba(219, 234, 254, 0.8); }
        body { font-family: Arial, sans-serif; background-color: #f3f4f6; font-size: 14px; }
        .topic-title { color: #1e40af; border-bottom: 1px solid #93c5fd; font-weight: 600; }
        .btn { transition: all 0.2s ease-in-out; border-radius: 6px; font-size: 12px; padding: 4px 10px; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-green { background-color: #16a34a; color: white; }
        .btn-green:hover { background-color: #15803d; }
        .form-input { background-color: #fff; border: 1px solid #d1d5db; padding: 4px 8px; font-size: 13px; border-radius: 6px; }
        textarea.form-input { overflow-y: hidden; }
        .form-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 2px #dbeafe; }
        label { font-size: 12px; font-weight: 500; color: #4b5563; }
        .preview-output { white-space: pre-wrap; background-color: #f9fafb; font-size: 13px; line-height: 1.6; color: #374151; height: auto; outline: none; padding: 8px; border-radius: 6px; border: 1px solid #e5e7eb; }
        .preview-output mark { background-color: var(--highlight-color); border-radius: 2px; padding: 1px 2px; }
        .btn-toggle { padding: 4px 12px; border: 1px solid #d1d5db; background-color: #f9fafb; color: #4b5563; font-size: 12px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease-in-out; }
        .btn-toggle.active { background-color: #2563eb; color: white; border-color: #2563eb; font-weight: 600; }
        .info-card { background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; }
        .tab-btn { padding: 8px 16px; border-radius: 6px 6px 0 0; font-weight: 600; cursor: pointer; border: 1px solid transparent; border-bottom: 0; }
        .tab-btn.active { background-color: white; border-color: #e5e7eb; }
        .tab-btn:not(.active) { background-color: #f3f4f6; }
        .tab-content, .tab-content-left { display: none; }
        .tab-content.active, .tab-content-left.active { display: block; }
        .checkbox-label { display: flex; align-items: center; cursor: pointer; font-size: 13px; color: #374151; }
        .checkbox-label input { margin-right: 8px; }
        .collapsible-content { transition: max-height 0.35s ease-out, padding-top 0.35s ease-out, padding-bottom 0.35s ease-out, margin-top 0.35s ease-out; overflow: hidden; max-height: 2000px; }
        .collapsible-content.collapsed { max-height: 0; padding-top: 0 !important; padding-bottom: 0 !important; margin-top: 0 !important; }
        .arrow-icon { transition: transform 0.3s ease-out; }
        .collapsible-header.collapsed .arrow-icon, .collapsible-subheader.collapsed .arrow-icon { transform: rotate(-90deg); }
        .model-btn { background-color: #e5e7eb; color: #374151; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        .model-btn:hover { background-color: #d1d5db; }
        @media (min-width: 1024px) { #right-column { position: sticky; top: 1rem; } }
    </style>
</head>
<body class="p-2 md:p-4">

    <main class="container mx-auto max-w-7xl">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:items-start">
            <!-- Coluna da Esquerda: Formulário -->
            <div class="flex flex-col">
                <div id="left-column-tabs" class="flex items-end -mb-px">
                    <button class="tab-btn active" data-tab-left="consulta">Consulta</button>
                    <button class="tab-btn" data-tab-left="historico">Histórico</button>
                </div>
                <div id="left-column-content-wrapper">
                    <div id="tab-content-consulta" class="tab-content-left active">
                        <div id="form-container" class="bg-white rounded-b-lg rounded-tr-lg shadow p-4 md:p-6 space-y-4">
                            <!-- Seções do Formulário -->
                            <section>
                                <div class="flex justify-between items-center pb-1 mb-2 border-b border-blue-300 cursor-pointer collapsible-header" data-section-id="identificacao">
                                    <div class="flex items-center">
                                        <svg class="arrow-icon w-4 h-4 mr-2 text-blue-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                        <h2 class="topic-title border-b-0 p-0 m-0">Identificação</h2>
                                    </div>
                                    <div>
                                        <span id="save-status" class="text-green-600 font-medium mr-2 opacity-0 transition-opacity duration-500">Salvo!</span>
                                        <button id="btn-novo-paciente" class="btn btn-green font-semibold py-1 px-3 -mb-1">Novo Paciente</button>
                                    </div>
                                </div>
                                <div class="space-y-3 pt-2 collapsible-content">
                                    <div class="info-card grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <input type="text" id="paciente-nome" placeholder="Nome do Paciente" class="form-input block w-full shadow-sm md:col-span-2">
                                        <input type="text" id="paciente-nascimento" placeholder="Nascimento (dd/mm/aaaa)" class="form-input block w-full shadow-sm">
                                    </div>
                                    <div class="info-card">
                                        <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="identificacao-detalhes">
                                            <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                            Detalhes Adicionais
                                        </h3>
                                        <div class="space-y-3 collapsible-content">
                                            <div class="flex items-center">
                                                <label class="mr-3 whitespace-nowrap">Acompanhante</label>
                                                <div class="flex items-center space-x-2 flex-grow" data-toggle-container="acompanhante">
                                                    <button type="button" data-value="nao" class="btn-toggle active">Não</button>
                                                    <button type="button" data-value="sim" class="btn-toggle">Sim</button>
                                                    <input type="text" id="paciente-acompanhante-detalhe" class="form-input flex-grow shadow-sm hidden" placeholder="Nome do acompanhante">
                                                </div>
                                            </div>
                                            <div class="flex items-center">
                                                <label for="paciente-ocupacao" class="mr-3 whitespace-nowrap">Ocupação</label>
                                                <input type="text" id="paciente-ocupacao" class="form-input w-full shadow-sm">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <section>
                                <div class="flex justify-between items-center pb-1 mb-2 border-b border-blue-300 cursor-pointer collapsible-header" data-section-id="dados">
                                    <div class="flex items-center">
                                        <svg class="arrow-icon w-4 h-4 mr-2 text-blue-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                        <h2 class="topic-title border-b-0 p-0 m-0 flex items-center">
                                            Dados
                                            <svg id="analise-spinner" class="animate-spin ml-2 h-4 w-4 text-blue-500 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                        </h2>
                                    </div>
                                </div>
                                <div class="collapsible-content">
                                    <textarea id="textarea-informacoes" class="form-input w-full shadow-sm mt-2" rows="5" placeholder="Cole uma evolução antiga, digite livremente para análise ou 'Novo' para limpar..."></textarea>
                                </div>
                            </section>
                            <section>
                                <h2 class="topic-title pb-1 mb-2 flex items-center cursor-pointer collapsible-header" data-section-id="diagnosticos">
                                    <svg class="arrow-icon w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    <span>Diagnóstico</span>
                                    <svg id="cid-spinner" class="animate-spin ml-2 h-4 w-4 text-blue-500 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </h2>
                                <div class="collapsible-content">
                                    <textarea id="textarea-diagnosticos" class="form-input w-full shadow-sm" rows="1" placeholder="Digite os diagnósticos. Ex: Cefaleia e enxaqueca"></textarea>
                                    <div id="modelos-container" class="info-card mt-4">
                                        <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="modelos-main">
                                            <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                            Modelos de Diagnóstico
                                        </h3>
                                        <div class="collapsible-content">
                                            <div class="space-y-3">
                                                <div class="info-card">
                                                    <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="modelo-cefaleia">
                                                        <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Cefaleia
                                                    </h3>
                                                    <div class="collapsible-content flex flex-wrap gap-2 pt-2">
                                                        <button type="button" class="model-btn" data-modelo="migraneaSemAura">Migrânea s/ Aura</button>
                                                        <button type="button" class="model-btn" data-modelo="migraneaComAura">Migrânea c/ Aura</button>
                                                        <button type="button" class="model-btn" data-modelo="cefaleiaTensional">Tensional</button>
                                                        <button type="button" class="model-btn" data-modelo="cefaleiaCronicaDiaria">Crônica Diária</button>
                                                        <button type="button" class="model-btn" data-modelo="cefaleiaEmSalvas">Em Salvas</button>
                                                    </div>
                                                </div>
                                                <div class="info-card">
                                                    <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="modelo-humor">
                                                        <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Humor
                                                    </h3>
                                                    <div class="collapsible-content flex flex-wrap gap-2 pt-2">
                                                        <button type="button" class="model-btn" data-modelo="tag">TAG</button>
                                                        <button type="button" class="model-btn" data-modelo="tdm">Depressão Maior</button>
                                                        <button type="button" class="model-btn" data-modelo="tab">Bipolar (TAB)</button>
                                                    </div>
                                                </div>
                                                <div class="info-card">
                                                    <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="modelo-neurodivergencia">
                                                        <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Neurodivergência
                                                    </h3>
                                                    <div class="collapsible-content flex flex-wrap gap-2 pt-2">
                                                        <button type="button" class="model-btn" data-modelo="tdah">TDAH</button>
                                                        <button type="button" class="model-btn" data-modelo="tea">TEA</button>
                                                        <button type="button" class="model-btn" data-modelo="dislexia">Dislexia</button>
                                                        <button type="button" class="model-btn" data-modelo="tod">TOD</button>
                                                    </div>
                                                </div>
                                                <div class="info-card">
                                                    <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="modelo-sono">
                                                        <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Sono
                                                    </h3>
                                                    <div class="collapsible-content flex flex-wrap gap-2 pt-2">
                                                        <button type="button" class="model-btn" data-modelo="insonia">Insônia</button>
                                                        <button type="button" class="model-btn" data-modelo="sahos">SAHOS</button>
                                                        <button type="button" class="model-btn" data-modelo="spi">Pernas Inquietas (SPI)</button>
                                                        <button type="button" class="model-btn" data-modelo="narcolepsia">Narcolepsia</button>
                                                        <button type="button" class="model-btn" data-modelo="sonambulismo">Sonambulismo</button>
                                                    </div>
                                                </div>
                                                <div class="info-card">
                                                    <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="modelo-epilepsia">
                                                        <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Epilepsia
                                                    </h3>
                                                    <div class="collapsible-content flex flex-wrap gap-2 pt-2">
                                                        <button type="button" class="model-btn" data-modelo="epilepsiaFocal">Focal</button>
                                                        <button type="button" class="model-btn" data-modelo="epilepsiaGeneralizada">Generalizada</button>
                                                        <button type="button" class="model-btn" data-modelo="cnep">Crises Não Epilépticas</button>
                                                    </div>
                                                </div>
                                                <!-- Síncope e Vertigem -->
                                                <div class="info-card">
                                                    <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="modelo-sincope">
                                                        <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Síncope e Vertigem
                                                    </h3>
                                                    <div class="collapsible-content flex flex-wrap gap-2 pt-2">
                                                        <button type="button" class="model-btn" data-modelo="sincopeVasovagal">Síncope Vasovagal</button>
                                                        <button type="button" class="model-btn" data-modelo="vertigemCentral">Vertigem Central</button>
                                                        <button type="button" class="model-btn" data-modelo="vertigemPeriferica">Vertigem Periférica</button>
                                                    </div>
                                                </div>
                                                <!-- Nervo Periférico e Junção Neuromuscular -->
                                                <div class="info-card">
                                                    <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="modelo-nervo">
                                                        <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Nervo Periférico
                                                    </h3>
                                                    <div class="collapsible-content flex flex-wrap gap-2 pt-2">
                                                        <button type="button" class="model-btn" data-modelo="parestesiaCutanea">Parestesia Cutânea</button>
                                                        <button type="button" class="model-btn" data-modelo="neuropatiaMetabolica">Neuropatia Metabólica</button>
                                                        <button type="button" class="model-btn" data-modelo="neuropatiaDiabetica">Neuropatia Diabética</button>
                                                    </div>
                                                </div>
                                                <!-- Neuromuscular -->
                                                <div class="info-card">
                                                    <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="modelo-neuromuscular">
                                                        <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Neuromuscular
                                                    </h3>
                                                    <div class="collapsible-content flex flex-wrap gap-2 pt-2">
                                                        <button type="button" class="model-btn" data-modelo="miasteniaGravis">Miastenia Gravis</button>
                                                        <button type="button" class="model-btn" data-modelo="ela">ELA</button>
                                                    </div>
                                                </div>
                                                <!-- Coluna -->
                                                <div class="info-card">
                                                    <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="modelo-coluna">
                                                        <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Coluna
                                                    </h3>
                                                    <div class="collapsible-content flex flex-wrap gap-2 pt-2">
                                                        <button type="button" class="model-btn" data-modelo="radiculopatiaCervical">Radiculopatia Cervical</button>
                                                        <button type="button" class="model-btn" data-modelo="lombalgia">Lombalgia</button>
                                                        <button type="button" class="model-btn" data-modelo="lombociatalgia">Lombociatalgia</button>
                                                    </div>
                                                </div>
                                                <!-- Cognição -->
                                                <div class="info-card">
                                                    <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="modelo-cognicao">
                                                        <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Cognição
                                                    </h3>
                                                    <div class="collapsible-content flex flex-wrap gap-2 pt-2">
                                                        <button type="button" class="model-btn" data-modelo="ccl">CCL</button>
                                                        <button type="button" class="model-btn" data-modelo="alzheimer">Alzheimer</button>
                                                        <button type="button" class="model-btn" data-modelo="demenciaVascular">Demência Vascular</button>
                                                        <button type="button" class="model-btn" data-modelo="demenciaLewy">Demência com Corpos de Lewy</button>
                                                        <button type="button" class="model-btn" data-modelo="demenciaFrontotemporal">Demência Frontotemporal</button>
                                                    </div>
                                                </div>
                                                <!-- Transtornos do Movimento -->
                                                <div class="info-card">
                                                    <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="modelo-movimento">
                                                        <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Transtornos do Movimento
                                                    </h3>
                                                    <div class="collapsible-content flex flex-wrap gap-2 pt-2">
                                                        <button type="button" class="model-btn" data-modelo="tremorEssencial">Tremor Essencial</button>
                                                        <button type="button" class="model-btn" data-modelo="doencaParkinson">Doença de Parkinson</button>
                                                        <button type="button" class="model-btn" data-modelo="parkinsonismoAtipicoGeral">Parkinsonismo Atípico</button>
                                                        <button type="button" class="model-btn" data-modelo="ams">AMS</button>
                                                        <button type="button" class="model-btn" data-modelo="psp">PSP</button>
                                                        <button type="button" class="model-btn" data-modelo="distonia">Distonia</button>
                                                        <button type="button" class="model-btn" data-modelo="distoniaCervical">Distonia Cervical</button>
                                                        <button type="button" class="model-btn" data-modelo="doencaHuntington">Doença de Huntington</button>
                                                        <button type="button" class="model-btn" data-modelo="coreiaSydenham">Coreia de Sydenham</button>
                                                        <button type="button" class="model-btn" data-modelo="ataxiaCerebelar">Ataxia Cerebelar</button>
                                                        <button type="button" class="model-btn" data-modelo="ataxiaHereditaria">Ataxia Hereditária</button>
                                                    </div>
                                                </div>
                                                <!-- Doenças Cerebrovasculares -->
                                                <div class="info-card">
                                                    <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="modelo-cerebrovascular">
                                                        <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Doenças Cerebrovasculares
                                                    </h3>
                                                    <div class="collapsible-content flex flex-wrap gap-2 pt-2">
                                                        <button type="button" class="model-btn" data-modelo="avciDireito">AVCi Hemisfério Direito</button>
                                                        <button type="button" class="model-btn" data-modelo="avciEsquerdo">AVCi Hemisfério Esquerdo</button>
                                                        <button type="button" class="model-btn" data-modelo="ait">AIT</button>
                                                        <button type="button" class="model-btn" data-modelo="avch">AVCh Intraparenquimatoso</button>
                                                        <button type="button" class="model-btn" data-modelo="hsa">HSA</button>
                                                        <button type="button" class="model-btn" data-modelo="tvc">Trombose Venosa Cerebral</button>
                                                    </div>
                                                </div>
                                                <!-- Doenças Inflamatórias -->
                                                <div class="info-card">
                                                    <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="modelo-inflamatorias">
                                                        <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Doenças Inflamatórias
                                                    </h3>
                                                    <div class="collapsible-content flex flex-wrap gap-2 pt-2">
                                                        <button type="button" class="model-btn" data-modelo="paralisiaBell">Paralisia de Bell</button>
                                                        <button type="button" class="model-btn" data-modelo="herpesZoster">Herpes Zoster</button>
                                                        <button type="button" class="model-btn" data-modelo="nevralgiaPosHerpetica">Nevralgia Pós-Herpética</button>
                                                    </div>
                                                </div>
                                                <!-- Doenças Desmielinizantes -->
                                                <div class="info-card">
                                                    <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="modelo-desmielinizantes">
                                                        <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Doenças Desmielinizantes
                                                    </h3>
                                                    <div class="collapsible-content flex flex-wrap gap-2 pt-2">
                                                        <button type="button" class="model-btn" data-modelo="emrr">EM Remitente-Recorrente</button>
                                                        <button type="button" class="model-btn" data-modelo="emProgressiva">EM Progressiva</button>
                                                        <button type="button" class="model-btn" data-modelo="cis">Síndrome Clínica Isolada</button>
                                                        <button type="button" class="model-btn" data-modelo="neuriteOptica">Neurite Óptica</button>
                                                        <button type="button" class="model-btn" data-modelo="nmosd">NMOSD</button>
                                                        <button type="button" class="model-btn" data-modelo="mieliteTransversa">Mielite Transversa</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <section>
                                <h2 class="topic-title pb-1 mb-2 flex items-center cursor-pointer collapsible-header" data-section-id="historia-inicial">
                                    <svg class="arrow-icon w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> <span>História Inicial</span>
                                </h2>
                                <div class="collapsible-content"><textarea id="historia-inicial" class="form-input w-full shadow-sm" rows="2" placeholder="Descrição da queixa inicial..."></textarea></div>
                            </section>
                            <section>
                                <h2 class="topic-title pb-1 mb-2 flex items-center cursor-pointer collapsible-header" data-section-id="atual">
                                    <svg class="arrow-icon w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> <span>Atual</span>
                                    <svg id="resumo-spinner" class="animate-spin ml-2 h-4 w-4 text-blue-500 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </h2>
                                <div class="collapsible-content"><textarea id="atual" class="form-input w-full shadow-sm" rows="1" placeholder="Resumo da consulta atual (gerado por IA se vazio)..."></textarea></div>
                            </section>
                            <section>
                                <h2 class="topic-title pb-1 mb-2 flex items-center cursor-pointer collapsible-header" data-section-id="historico">
                                    <svg class="arrow-icon w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> <span>Histórico</span>
                                </h2>
                                <div class="space-y-3 collapsible-content">
                                    <div class="info-card">
                                        <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="comorbidades">
                                            <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Comorbidades
                                        </h3>
                                        <div class="collapsible-content"><textarea id="textarea-comorbidades" class="form-input w-full shadow-sm" rows="1" placeholder="Uma comorbidade por linha..."></textarea></div>
                                    </div>
                                    <div class="info-card">
                                        <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="cirurgias">
                                            <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Cirurgias / Hospitalizações
                                        </h3>
                                        <div class="collapsible-content"><textarea id="cirurgias-hospitalizacoes" class="form-input block w-full shadow-sm" rows="1" placeholder="Nega ou descreva..."></textarea></div>
                                    </div>
                                    <div class="info-card">
                                        <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="habitos">
                                            <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Hábitos
                                        </h3>
                                        <div class="space-y-2 collapsible-content">
                                            <div class="flex items-center">
                                                <label class="mr-3 whitespace-nowrap">Etilismo</label>
                                                <div class="flex items-center space-x-2 flex-grow" data-toggle-container="etilismo">
                                                    <button type="button" data-value="nao" class="btn-toggle active">Nega</button>
                                                    <button type="button" data-value="sim" class="btn-toggle">Sim</button>
                                                    <input type="text" id="habito-etilismo-detalhe" class="form-input flex-grow shadow-sm hidden" placeholder="Detalhes...">
                                                </div>
                                            </div>
                                            <div class="flex items-center">
                                                <label class="mr-3 whitespace-nowrap">Tabagismo</label>
                                                <div class="flex items-center space-x-2 flex-grow" data-toggle-container="tabagismo">
                                                    <button type="button" data-value="nao" class="btn-toggle active">Nega</button>
                                                    <button type="button" data-value="sim" class="btn-toggle">Sim</button>
                                                    <input type="text" id="habito-tabagismo-detalhe" class="form-input flex-grow shadow-sm hidden" placeholder="Detalhes...">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <section>
                                <h2 class="topic-title pb-1 mb-2 flex items-center cursor-pointer collapsible-header" data-section-id="medicamentos">
                                    <svg class="arrow-icon w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> <span>Medicamentos</span>
                                </h2>
                                <div class="space-y-3 collapsible-content">
                                    <div class="info-card">
                                        <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="uso-atual">
                                            <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Uso Atual
                                        </h3>
                                        <div class="collapsible-content"><textarea id="textarea-medicamentos-atuais" class="form-input w-full shadow-sm" rows="1" placeholder="Losartana 50mg 1-0-0..."></textarea></div>
                                    </div>
                                    <div class="info-card">
                                        <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="uso-previo">
                                            <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Uso Prévio
                                        </h3>
                                        <div class="collapsible-content"><textarea id="textarea-medicamentos-previos" class="form-input w-full shadow-sm" rows="1" placeholder="Nega ou descreva..."></textarea></div>
                                    </div>
                                </div>
                            </section>
                            <section>
                                <h2 class="topic-title pb-1 mb-2 flex items-center cursor-pointer collapsible-header" data-section-id="complementares">
                                    <svg class="arrow-icon w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> <span>Exames Complementares</span>
                                </h2>
                                <div class="collapsible-content"><textarea id="textarea-complementares" class="form-input w-full shadow-sm" rows="1" placeholder="RM Crânio (01/01/25): sem alterações..."></textarea></div>
                            </section>
                            <section>
                                <h2 class="topic-title pb-1 mb-2 flex items-center cursor-pointer collapsible-header" data-section-id="exame-fisico">
                                    <svg class="arrow-icon w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> <span>Exame Físico/Neurológico</span>
                                </h2>
                                <div class="collapsible-content"><textarea id="exame-fisico" class="form-input w-full shadow-sm" rows="2" placeholder="Vigil, orientado..."></textarea></div>
                            </section>
                            <section>
                                <h2 class="topic-title pb-1 mb-2 flex items-center cursor-pointer collapsible-header" data-section-id="conduta">
                                    <svg class="arrow-icon w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> <span>Conduta</span>
                                </h2>
                                <div class="space-y-3 collapsible-content">
                                    <div class="info-card">
                                        <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="conduta-medicamento">
                                            <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Medicamento
                                        </h3>
                                        <div class="collapsible-content"><textarea id="textarea-terapia" class="form-input w-full shadow-sm" rows="2" placeholder="desvenlafaxina 50mg 1-0-0&#10;prednisona bell"></textarea></div>
                                    </div>
                                    <div class="info-card">
                                        <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="conduta-exames">
                                            <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Exames
                                        </h3>
                                        <div class="collapsible-content"><textarea id="conduta-exames" class="form-input w-full shadow-sm" rows="1" placeholder="Solicito RM de Crânio..."></textarea></div>
                                    </div>
                                    <div class="info-card">
                                        <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="conduta-encaminhamento">
                                            <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Encaminhamento
                                        </h3>
                                        <div class="collapsible-content"><textarea id="conduta-encaminhamento" class="form-input w-full shadow-sm" rows="1" placeholder="Encaminho para Fisioterapia..."></textarea></div>
                                    </div>
                                    <div class="info-card">
                                        <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer collapsible-subheader flex items-center" data-subsection-id="conduta-documentos">
                                            <svg class="arrow-icon w-3 h-3 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg> Documentos
                                        </h3>
                                        <div class="collapsible-content">
                                            <div id="conduta-documentos-container" class="grid grid-cols-2 gap-x-8 gap-y-2 mt-2">
                                                <div class="col-span-2 flex items-center space-x-4">
                                                    <label class="checkbox-label flex-shrink-0"><input type="checkbox" name="documento" value="Atestado" id="checkbox-atestado"> Atestado</label>
                                                    <input type="text" id="atestado-dias" class="form-input w-28 shadow-sm hidden transition-all" placeholder="Nº de dias">
                                                </div>
                                                <div class="col-span-2 flex items-center space-x-4">
                                                    <label class="checkbox-label flex-shrink-0"><input type="checkbox" name="documento" value="Declaração" id="checkbox-declaracao"> Declaração</label>
                                                    <input type="text" id="declaracao-acompanhante" class="form-input w-full shadow-sm hidden transition-all" placeholder="Nome do Acompanhante (Opcional)">
                                                </div>
                                                <div class="col-span-2">
                                                    <label class="checkbox-label"><input type="checkbox" name="documento" value="Laudo" id="checkbox-laudo"> Laudo</label>
                                                    <div id="laudo-opcoes" class="pl-6 pt-2 space-y-1 hidden">
                                                        <label class="checkbox-label text-sm"><input type="radio" name="laudo-tipo" value="Diagnóstico" checked> Diagnóstico</label>
                                                        <label class="checkbox-label text-sm"><input type="radio" name="laudo-tipo" value="Incapacidade"> Incapacidade</label>
                                                        <label class="checkbox-label text-sm"><input type="radio" name="laudo-tipo" value="Concurso"> Concurso</label>
                                                        <label class="checkbox-label text-sm"><input type="radio" name="laudo-tipo" value="Neurodivergente"> Neurodivergente</label>
                                                    </div>
                                                </div>
                                                <label class="checkbox-label"><input type="checkbox" name="documento" value="Orientações"> Orientações</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>
                    <div id="tab-content-historico" class="tab-content-left bg-white rounded-b-lg rounded-tr-lg shadow p-4 md:p-6">
                        <div class="p-2">
                            <h3 class="font-semibold text-gray-700 mb-2">Buscar Paciente</h3>
                            <input type="text" id="search-historico" class="form-input w-full" placeholder="Buscar por Nome, Idade, ou Diagnóstico...">
                            <div id="search-results-container" class="mt-4 space-y-4"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coluna da Direita: Prévia -->
            <div id="right-column">
                <div class="flex -mb-px">
                    <button class="tab-btn active" data-tab="evolucao">Evolução</button>
                    <button class="tab-btn" data-tab="receita">Receita</button>
                    <button class="tab-btn" data-tab="documentos">Documentos</button>
                </div>
                <div class="bg-white rounded-b-lg rounded-tr-lg shadow p-4 md:p-6">
                    <div id="tab-content-evolucao" class="tab-content active">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold text-gray-700">Prévia da Evolução</h3>
                            <button id="btn-copiar-evolucao" class="btn btn-primary font-semibold py-1 px-3">Salvar & Copiar</button>
                        </div>
                        <pre id="evolucao-output" class="preview-output font-mono">Carregando dados...</pre>
                    </div>
                    <div id="tab-content-receita" class="tab-content">
                        <div class="flex items-center justify-center mb-4">
                            <button id="btn-copiar-todas-receitas" class="btn btn-primary font-semibold py-2 px-4">Copiar Todas as Receitas</button>
                        </div>
                        <div id="receita-container" class="space-y-4"></div>
                    </div>
                    <div id="tab-content-documentos" class="tab-content">
                        <div class="flex items-center justify-center mb-4">
                            <button id="btn-copiar-todos-documentos" class="btn btn-primary font-semibold py-2 px-4">Copiar Todos os Documentos</button>
                        </div>
                        <div id="documentos-container" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
        
    <footer class="text-center mt-4 text-gray-500 text-sm">
        <p>Sistema de Evolução Médica &copy; 2025</p>
    </footer>

    <script type="module">
        // --- CONSTANTES E DADOS ESTÁTICOS ---
        const PACIENTES_DB_KEY = 'pacientesDatabase_v2_singleRecord';
        const DATA_STORAGE_KEY = 'evolucaoMedicaData_v17_singleRecord';
        const COLLAPSIBLE_STATE_KEY = 'collapsibleState_v1';
        const COLLAPSIBLE_SUB_STATE_KEY = 'collapsibleSubState_v1';
        
        let dadosAnalisados = {}; 
        let isProgrammaticChange = false; 

        const StaticData = {
            SIGLAS: ['RM', 'ECG', 'EEG', 'TC', 'HAS', 'HPB', 'AVC', 'AIT', 'IAM', 'DPOC', 'UTI', 'PS', 'DM', 'IRC', 'PA', 'FC', 'FR', 'S/A', 'HD', 'CD', 'ABD', 'SNC', 'SNP', 'LCR', 'USG', 'CP', 'TCE'],
            SIGLAS_REGEX: new RegExp(`\\b(${['rm', 'ecg', 'eeg', 'tc', 'has', 'hpb', 'avc', 'ait', 'iam', 'dpoc', 'uti', 'ps', 'dm', 'irc', 'pa', 'fc', 'fr', 's/a', 'hd', 'cd', 'abd', 'snc', 'snp', 'lcr', 'usg', 'cp', 'tce'].join('|')})\\b`, 'gi'),
            MEDICAMENTO_MAP: {'desvenlafaxina': '(Pristiq / Deller)','pregabalina': '(Prebictal / Insit)','topiramato': '(Amato)','escitalopram': '(Lexapro / Exodus)','fluoxetina': { ref: '(Prozac / Daforin)', form: 'cápsula' },'vortioxetina': '(Brintellix / Vurtuoso)','sertralina': '(Zoloft / Tolrest)','paracetamol': '(Tylenol)','ibuprofeno': '(Alivium)','naratriptana': '(Naramig)','sumatriptana': '(Sumax)','ondansetrona': '(Vonau Flash)','ciclobenzaprina': '(Miosan)','colírio lubrificante': '(Hyabak / Lacrima Plus)','gel oftálmico': '(Epitegel)','passiflora incarnata': '(Pasalix PI / Sosseg)','meclizina comprimidos mastigáveis': '(Meclin Jet)','mecobalamina': '(Dozemast)','tiamina+piridoxina+cianocobalamina': '(Citoneurin 5.000)','dozemast np': '(Dozemast NP)','nortriptilina': { ref: '(Pamelor)', form: 'cápsula' },'duloxetina': { ref: '(Cymbalta / Velija)', form: 'cápsula' },'trazodona': '(Donaren)','ramelteona': '(Rahime)','difenidramina': '(Lenix)','quetiapina': '(Seroquel / Quetros)','quetiapina liberação prolongada': '(Seroquel XRO)','valaciclovir': '(Valtrex)','bupropiona liberação prolongada': '(Wellbutrin XL / Bup XL)','atomoxetina': { ref: '(Atentah)', form: 'cápsula' },'risperidona': '(Risperdal / Zargus)','aripiprazol': '(Aristab)','ácido acetilsalicílico': '(Aspirina Prevent)','clopidogrel': '(Plavix / Clopin)','rosuvastatina': '(Crestor / Trezor)','ácido acetilsalicílico e clopidogrel': '(Clopin Duo)','levetiracetam': '(Keppra)','divalproato de sódio': '(Depakote ER / Divalcon ER)','lamotrigina': '(Lamictal)','oxcarbazepina': '(Trileptal)','fenitoína': '(Hidantal)','galantamina - cápsulas de liberação prolongada': { ref: '(Reminyl ER / Regressa)', form: 'cápsula' },'donepezila': '(Donila)','memantina': '(Ebix / Alois)','donepezila + memantina': '(Alois Duo)','levodopa+benserazida': '(Prolopa BD / Ekson)','entacapona': '(Comtan)','levodopa+carbidopa+entacapona': '(Stalevo)','pramipexol liberação prolongada': '(Sifrol ER / Pisa)','amantadina': '(Mantidan)'},
            RECEITAS_ESPECIAIS: {'desvenlafaxina 50mg 1-0-0':{uso:"USO ORAL E CONTÍNUO",medicamento:"Desvenlafaxina (Pristiq / Deller) 50mg",quantidade:"60 comprimidos",instrucoes:["Tome 1 comprimido após o café da manhã"]},'desvenlafaxina 100mg 1-0-0':{uso:"USO ORAL E CONTÍNUO",medicamento:"Desvenlafaxina (Pristiq / Deller) 100mg",quantidade:"60 comprimidos",instrucoes:["Tome 1 comprimido após o café da manhã"]},'escitalopram 10mg - inicio':{uso:"USO ORAL E CONTÍNUO",medicamento:"Escitalopram (Lexapro / Exodus) 10mg",quantidade:"60 comprimidos",instrucoes:["Tome 0,5 (meio) comprimido ao dia por 7 dias","Após 7 dias, passe a tomar 1 comprimido ao dia, todos os dias"]},'escitalopram 10mg':{uso:"USO ORAL E CONTÍNUO",medicamento:"Escitalopram (Lexapro / Exodus) 10mg",quantidade:"60 comprimidos",instrucoes:["Tome 1 comprimido ao dia, todos os dias"]},'escitalopram 15mg':{uso:"USO ORAL E CONTÍNUO",medicamento:"Escitalopram (Lexapro / Exodus) 15mg",quantidade:"60 comprimidos",instrucoes:["Tome 1 comprimido ao dia, todos os dias"]},'escitalopram 20mg':{uso:"USO ORAL E CONTÍNUO",medicamento:"Escitalopram (Lexapro / Exodus) 20mg",quantidade:"60 comprimidos",instrucoes:["Tome 1 comprimido ao dia, todos os dias"]},'fluoxetina 10mg 1-0-0':{uso:"USO ORAL E CONTÍNUO",medicamento:"Fluoxetina (Prozac / Daforin) 10mg",quantidade:"60 cápsulas",instrucoes:["Tome 1 cápsula pela manhã"]},'fluoxetina 20mg 1-0-0':{uso:"USO ORAL E CONTÍNUO",medicamento:"Fluoxetina (Prozac / Daforin) 20mg",quantidade:"60 cápsulas",instrucoes:["Tome 1 cápsula pela manhã"]},'fluoxetina 10mg 2-0-0':{uso:"USO ORAL E CONTÍNUO",medicamento:"Fluoxetina (Prozac / Daforin) 20mg",quantidade:"120 cápsulas",instrucoes:["Tome 2 cápsulas pela manhã"]},'vortioxetina - inicio':{uso:"USO ORAL E CONTÍNUO",medicamento:"Vortioxetina (Brintellix / Vurtuoso) 10mg",quantidade:"60 comprimidos",instrucoes:["Tome 0,5 (meio) comprimido ao dia por 7 dias","Após 7 dias, passe a tomar 1 comprimido ao dia, todos os dias"]},'vortioxetina 10mg':{uso:"USO ORAL E CONTÍNUO",medicamento:"Vortioxetina (Brintellix / Vurtuoso) 10mg",quantidade:"60 comprimidos",instrucoes:["Tome 1 comprimido ao dia, todos os dias"]},'vortioxetina 20mg':{uso:"USO ORAL E CONTÍNUO",medicamento:"Vortioxetina (Brintellix / Vurtuoso) 20mg",quantidade:"60 comprimidos",instrucoes:["Tome 1 comprimido ao dia, todos os dias"]},'sertralina 25mg':{uso:"USO ORAL E CONTÍNUO",medicamento:"Sertralina ( Tolrest ) 25mg",quantidade:"60 comprimidos",instrucoes:["Tome 1 comprimido ao dia, todos os dias"]},'sertralina 50mg - inicio':{uso:"USO ORAL E CONTÍNUO",medicamento:"Sertralina (Zoloft / Tolrest ) 50mg",quantidade:"60 comprimidos",instrucoes:["Tome 0,5 (meio) comprimido ao dia por 7 dias","Após 7 dias, passe a tomar 1 comprimido ao dia, todos os dias"]},'sertralina 50mg':{uso:"USO ORAL E CONTÍNUO",medicamento:"Sertralina (Zoloft / Tolrest ) 50mg",quantidade:"60 comprimidos",instrucoes:["Tome 1 comprimido ao dia, todos os dias"]},'sertralina 100mg':{uso:"USO ORAL E CONTÍNUO",medicamento:"Sertralina (Zoloft / Tolrest ) 100mg",quantidade:"60 comprimidos",instrucoes:["Tome 1 comprimido ao dia, todos os dias"]},'paracetamol':{uso:"USO ORAL",medicamento:"Paracetamol (Tylenol) 750mg",quantidade:"01 caixa",instrucoes:["Tome 1 comprimido até de 6/6h, se dor","Evite tomar mais que 3 comprimidos por semana"]},'ibuprofeno':{uso:"USO ORAL",medicamento:"Ibuprofeno (Alivium) 600mg",quantidade:"01 caixa",instrucoes:["Tome 1 comprimido até de 8/8h, se dor forte","Evite tomar mais que 3 comprimidos por semana","Não tome mais que 5 dias seguidos"]},'naratriptana':{uso:"USO ORAL",medicamento:"Naratriptana (Naramig) 2,5mg",quantidade:"01 caixa",instrucoes:["Tome 1 comprimido, se dor de cabeça forte","Se não melhorar dentro de 4 horas, tome o 2º comprimido","Não tome mais que 2 comprimidos ao dia","Evite tomar mais que 3 comprimidos na semana"]},'sumatriptana':{uso:"USO ORAL",medicamento:"Sumatriptana (Sumax) 50mg",quantidade:"01 caixa",instrucoes:["Tome 1 comprimido, se dor de cabeça forte","Se não melhorar dentro de 2 horas, tome o 2º comprimido","Não tome mais que 2 comprimidos ao dia","Evite tomar mais que 3 comprimidos na semana"]},'vonau':{uso:"USO SUBLINGUAL",medicamento:"Ondansetrona (Vonau Flash) 4mg",quantidade:"01 caixa",instrucoes:["Absorver em baixo da língua 1 comprimido a cada 8 horas, se náusea ou vômito"]},'ciclobenzaprina':{uso:"USO ORAL",medicamento:"Ciclobenzaprina (Miosan) 5mg",quantidade:"7 comprimidos",instrucoes:["Tome 1 comprimido antes de dormir, por 7 dias"]},'prednisona bell':{uso:"USO ORAL",medicamento:"Prednisona 20mg",quantidade:"28 comprimidos",instrucoes:["Dia 1 ao 7 - Tome 3 comprimidos as 08h","Dia 8 e 9 - Tome 2 comprimidos as 08h","Dia 10 e 11 - Tome 1 comprimido as 08h","Dia 12 e 13 - Tome 0,5 (meio) comprimido as 08h"]},'valaciclovir':{uso:"USO ORAL",medicamento:"Valaciclovir (Valtrex) 500mg",quantidade:"42 comprimidos",instrucoes:["Tome 2 comprimidos de manhã, 2 comprimidos a tarde e 2 comprimidos a noite (de 8/8h) por 7 dias"]},'prednisona zoster':{uso:"USO ORAL",medicamento:"Prednisona 20mg",quantidade:"15 comprimidos",instrucoes:["Dia 1 ao 6 - Tome 2 comprimidos as 08h","Dia 7 e 8 - Tome 1 comprimido as 08h","Dia 9 e 10 - Tome 0,5 (meio) comprimido as 08h"]}},
        };
        const DocumentTemplates = {
            ASSINATURA: `\n\n\n___________________________________\nDr. Eduardo Savoldi\nCRMPR 33191\nRQE25506`,
            ORIENTACOES_AVC: `Dr. Eduardo Savoldi\nNeurologista — CRM-PR 33191 | RQE 25506\n\n[NOME_PACIENTE]\n[DATA_CONSULTA]\n\nORIENTAÇÃO MÉDICA — ACIDENTE VASCULAR CEREBRAL (AVC)\n\nO que é o AVC\n\nO Acidente Vascular Cerebral (AVC) ocorre quando o sangue deixa de chegar corretamente a uma parte do cérebro.\nIsso pode acontecer por dois motivos principais:\n\n- Entupimento de uma artéria (AVC isquêmico), impedindo a passagem do sangue.\n- Rompimento de uma artéria (AVC hemorrágico), causando sangramento dentro ou ao redor do cérebro.\n\nQuando o cérebro fica sem sangue, as células cerebrais sofrem e podem morrer rapidamente.\n\nComo o AVC afeta as pessoas\n\nOs efeitos do AVC variam conforme a região do cérebro afetada e a rapidez do tratamento.\nAlgumas pessoas se recuperam totalmente, enquanto outras podem apresentar sequelas, como:\n\n- Fraqueza ou paralisia em um lado do corpo\n- Dificuldade para falar ou compreender o que os outros dizem\n- Alterações na visão ou no equilíbrio\n\nO AVC é uma das principais causas de morte e incapacidade no mundo.\nReconhecer os sinais e agir rapidamente é fundamental.\n\nComo reconhecer um AVC\n\nUse a palavra SAMU para lembrar dos sinais de alerta:\n\nS — Sorria: Peça para a pessoa sorrir. O rosto está torto?\nA — Abrace: Peça para levantar os dois braços. Um braço cai ou está fraco?\nM — Música (fale): Peça para repetir uma frase simples. A fala está enrolada ou difícil de entender?\n\nU — Urgente: Se houver qualquer um desses sinais, ligue imediatamente 192 (SAMU).\n\nCada minuto conta. Quanto mais rápido o atendimento, maiores as chances de recuperação.\n\nComo o AVC é tratado\n\nO tratamento depende do tipo de AVC:\n\nAVC por entupimento (isquêmico)\n- Uso de medicamentos que desentopem a artéria (trombolíticos), se aplicável\n- Uso de medicamentos que afinam o sangue, para prevenir novos episódios\n- Controle rigoroso da pressão arterial, colesterol e glicose\n\nAVC por sangramento (hemorrágico)\n- Controle do sangramento e da pressão arterial\n- Suspensão ou ajuste de medicamentos que aumentam o risco de sangramento\n- Cirurgia para conter o sangramento, quando indicada\n\nO AVC pode ser evitado\n\nGrande parte dos AVCs pode ser prevenida com cuidados adequados e tratamento regular.\n\n1. Uso correto dos medicamentos:\n- Medicamentos para controle da pressão arterial\n- Estatinas para reduzir o colesterol\n- Anticoagulantes ou aspirina, se indicados\n- Medicamentos para controle do diabetes\n\n2. Mudanças no estilo de vida:\n- Parar de fumar\n- Praticar atividade física regularmente (pelo menos 30 minutos na maioria dos dias)\n- Manter o peso dentro da faixa saudável\n- Alimentar-se de forma equilibrada, com frutas, verduras e produtos com baixo teor de gordura\n- Reduzir o consumo de sal e álcool\n\nOrientação final\n\nO AVC é uma emergência médica.\nReconhecer os sinais e procurar atendimento imediato pode salvar vidas e reduzir as sequelas.\nApós um AVC, o acompanhamento médico e a reabilitação são fundamentais para a recuperação e qualidade de vida.`,
        };
        const LaudoStrategies = {
            'Incapacidade':(c,n,d,s,r)=>{const u=d.toUpperCase(),a=(new Date).toLocaleDateString("pt-BR"),o=`Paciente: ${n}\nData: ${a}\n\n`,t=`LAUDO MÉDICO PARA FINS DE AVALIAÇÃO DE INCAPACIDADE\n\n${o}Atesto que o(a) paciente supracitado(a) encontra-se em acompanhamento médico regular sob meus cuidados por apresentar quadro clínico de ${u}.\n\nDevido à sua condição, o(a) paciente apresenta limitações funcionais significativas que o(a) incapacitam para o trabalho e/ou atividades da vida diária. [Descrever as limitações funcionais específicas que justificam a incapacidade]\n\nA condição é crônica e necessita de tratamento contínuo.\n\nCID-10: ${d.match(/\((.*?)\)/)?.[1]||"[CID]"}\n\nCuritiba, ${a}.`;return t+s},
            'Concurso':(c,n,d,s,r)=>{const o=`LAUDO NEUROLÓGICO PARA CONCURSO/ADMISSÃO\n\nDeclaro, para os devidos fins, que ${n}:\n\n- Esteve em consulta com neurologista nesta data.\n- Não apresenta histórico pessoal ou familiar de doença neurológica incapacitante.\n- Não apresenta alterações ao exame neurológico atual.\n\nConclusão: Ausência de patologia neurológica que impeça o exercício do cargo, estando APTO(A) a exercer o cargo proposto.\n`;return o+s},
            'Neurodivergente':(c,n,d,s,r)=>{const i=/TEA|Transtorno do Espectro Autista/i.test(d),u=i?" e Lei nº 12.764/2012 (Política Nacional de Proteção dos Direitos da Pessoa com Transtorno do Espectro Autista)":"",p=c.conduta.encaminhamento?.map(e=>e.texto).join(", ")||"[]",m=c.medicamentos.usoAtual?.map(e=>e.texto).join(", ")||"Não faz uso de medicações no momento.",a=(new Date).toLocaleDateString("pt-BR"),o=`Paciente: ${n}\nData: ${a}\n\n`,t=`LAUDO NEURODIVERGENTE\n\n${o}Declaro, para os devidos fins, que ${n}:\n\nApresenta o(s) Diagnóstico(s):\n- ${d}\n\nEstá em uso atual dos medicamentos: ${m}\n\nApresenta indicação de terapias com: ${p}\n\nRecomenda-se também a inclusão do(a) paciente em programa educacional regular, com suporte pedagógico e terapêutico adequados, conforme suas necessidades específicas. Conforme o art. 2º da Lei nº 13.146/2015 (Lei Brasileira de Inclusão da Pessoa com Deficiência)${u}.`;return t+s},
            'Diagnóstico':(c,n,d,s,r)=>{const u=c.medicamentos.usoAtual?.map(e=>e.texto).join(", ")||"Não faz uso de medicações no momento.",a=(new Date).toLocaleDateString("pt-BR"),o=`Paciente: ${n}\nData: ${a}\n\n`,t=`LAUDO MÉDICO\n\n${o}Declaro, para os devidos fins, que ${n}\n\nApresenta o(s) diagnóstico(s):\n- ${d}\n\nEstá em uso atual dos seguintes medicamentos: ${u}\n\nEm consulta médica realizada em ${a} apresenta ${r(c.exameFisico,"ausência de alterações significativas")}.`;return t+s}
        };

        const MODELOS_COMPLETOS = {
            'migraneaSemAura': { diagnosticos: [{ texto: 'Migrânea sem Aura (G43.0)' }], historiaInicial: { texto: 'Cefaleia pulsátil, forte, unilateral, com 4-72h de duração, que piora com atividades físicas.\nAssociada a náusea/vômitos, fotofobia e fonofobia.' }, exameFisico: { texto: 'Normal no período intercrítico.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Crise aguda: Analgésicos comuns, AINEs ou Triptanas.' }], examesSolicitados: [{ texto: 'Neuroimagem não indicada em quadros típicos com exame neurológico normal, salvo sinais de alarme.' }], encaminhamento: [{ texto: 'Desnecessário, exceto em casos refratários ou com sinais de alarme.' }] }},
            'migraneaComAura': { diagnosticos: [{ texto: 'Migrânea com Aura (G43.1)' }], historiaInicial: { texto: 'Cefaleia migranosa precedida ou acompanhada por aura (sintomas neurológicos focais transitórios).\nCada sintoma da aura dura de 5 a 60 min, com pelo menos um sendo unilateral, e é seguida pela cefaleia em até 60 min.' }, exameFisico: { texto: 'Normal fora da crise.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Crise aguda: Analgésicos, AINEs, Triptanas.' }], examesSolicitados: [{ texto: 'Neuroimagem não rotineira, a menos que haja auras atípicas ou sinais de alarme.' }], encaminhamento: [{ texto: 'Desnecessário, exceto em casos refratários ou com sinais de alarme.' }] }},
            'cefaleiaTensional': { diagnosticos: [{ texto: 'Cefaleia do Tipo Tensional (G44.2)' }], historiaInicial: { texto: 'Dor bilateral tipo aperto/pressão, com fotofobia ou fonofobia (não ambas) e sem náuseas.\nComum hipersensibilidade da musculatura pericraniana.' }, exameFisico: { texto: 'Normal, podendo haver sensibilidade à palpação da musculatura pericraniana/cervical.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Analgésicos comuns (Paracetamol, Aspirina) ou AINEs (Ibuprofeno).' }], examesSolicitados: [{ texto: 'Sem indicação em casos típicos.' }], encaminhamento: [] }},
            'cefaleiaCronicaDiaria': { diagnosticos: [{ texto: 'Cefaleia Crônica Diária (G44.8)' }], historiaInicial: { texto: 'Cefaleia por 15 ou mais dias/mês.\nInvestigar uso excessivo de medicações abortivas como fator perpetuador.' }, exameFisico: { texto: 'Tipicamente normal; atentar para sinais de alarme.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Interromper uso excessivo de sintomáticos e instituir tratamento preventivo (ex: valproato de sódio, amitriptilina).' }], examesSolicitados: [{ texto: 'Neuroimagem para excluir causas secundárias.' }], encaminhamento: [{ texto: 'Equipe multidisciplinar (dor, psicologia) em casos refratários.' }] }},
            'cefaleiaEmSalvas': { diagnosticos: [{ texto: 'Cefaleia em Salvas (G44.0)' }], historiaInicial: { texto: 'Ataques de dor excruciante, lancinante e estritamente unilateral (região orbital), de rápida intensidade máxima (3-5 min), ocorrendo em "salvas".\nAssociada a sintomas autonômicos ipsilaterais (congestão nasal, lacrimejamento, miose/ptose).' }, exameFisico: { texto: 'Normal no período intercrítico; sinais autonômicos presentes durante a crise.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Tratamento agudo altamente específico.' }], examesSolicitados: [{ texto: 'RM de encéfalo no diagnóstico inicial para descartar causas secundárias.' }], encaminhamento: [{ texto: 'Neurologista especialista em cefaleias.' }] }},
            'tag': { diagnosticos: [{ texto: 'Transtorno de Ansiedade Generalizada (F41.1)' }], historiaInicial: { texto: 'Ansiedade e preocupação excessivas e persistentes por no mínimo seis meses, com dificuldade de controle.\nRequer ≥3 sintomas: inquietação, fatigabilidade, dificuldade de concentração, irritabilidade, tensão muscular, perturbação do sono.' }, exameFisico: { texto: 'Normal, podendo haver sinais de tensão muscular ou agitação.' }, conduta: { terapiaMedicamentosa: [{ texto: 'ISRSs (1ª linha), Benzodiazepínicos (curto prazo).' }], examesSolicitados: [{ texto: 'Laboratoriais para excluir causas orgânicas (ex: tireoide).' }], encaminhamento: [{ texto: 'Psicoterapia (TCC) e/ou psiquiatria.' }] }},
            'tdm': { diagnosticos: [{ texto: 'Transtorno Depressivo Maior (F33.9)' }], historiaInicial: { texto: 'Requer ≥5 dos seguintes sintomas por 2 semanas (obrigatório humor deprimido ou anedonia): humor deprimido, anedonia, alterações de peso/apetite, insônia/hipersonia, agitação/retardo psicomotor, fadiga, inutilidade/culpa, dificuldade de concentração, ideação suicida.' }, exameFisico: { texto: 'Geralmente normal; pode-se observar retardo ou agitação psicomotora.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Antidepressivos (ISRSs).' }], examesSolicitados: [{ texto: 'Para excluir causas médicas.' }], encaminhamento: [{ texto: 'Psiquiatria e psicoterapia.' }] }},
            'tab': { diagnosticos: [{ texto: 'Transtorno Afetivo Bipolar (F31.9)' }], historiaInicial: { texto: 'Requer ao menos um episódio maníaco.\nEpisódio Maníaco: ≥1 semana de humor elevado/irritável e aumento de energia, com ≥3 sintomas: autoestima inflada, sono reduzido, loquacidade, fuga de ideias, distratibilidade, atividades de risco.' }, exameFisico: { texto: 'Normal; achados comportamentais variam com o estado do humor.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Estabilizadores de humor e/ou Antipsicóticos.' }], examesSolicitados: [{ texto: 'Toxicológicos para excluir mania induzida por substâncias.' }], encaminhamento: [{ texto: 'Psiquiatria.' }] }},
            'tdah': { diagnosticos: [{ texto: 'Transtorno do Déficit de Atenção com Hiperatividade (F90.0)' }], historiaInicial: { texto: 'Padrão persistente de desatenção e/ou hiperatividade-impulsividade que interfere no funcionamento.\nDesatenção: Dificuldade em manter foco, parece não ouvir, perde objetos.\nHiperatividade/Impulsividade: Inquietude, levanta-se indevidamente, fala excessiva, interrompe outros.' }, exameFisico: { texto: 'Geralmente normal; recomenda-se avaliar coordenação motora.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Estimulantes (metilfenidato) e não estimulantes.' }], examesSolicitados: [{ texto: 'Diagnóstico clínico; testes neuropsicológicos podem auxiliar.' }], encaminhamento: [{ texto: 'Psicoterapia, intervenção psicopedagógica, psiquiatria.' }] }},
            'tea': { diagnosticos: [{ texto: 'Transtorno do Espectro Autista (F84.0)' }], historiaInicial: { texto: 'Déficits persistentes em 2 domínios:\n1. Comunicação e interação social: Dificuldades na reciprocidade, comunicação não verbal e relacionamentos.\n2. Padrões restritos e repetitivos: Movimentos estereotipados, insistência na rotina, interesses fixos, hiper/hiporreatividade sensorial.' }, exameFisico: { texto: 'Pode ser normal; avaliar comorbidades (def. intelectual, transtornos motores).' }, conduta: { terapiaMedicamentosa: [{ texto: 'Foco em comorbidades; não há medicação para sintomas nucleares.' }], examesSolicitados: [{ texto: 'Avaliação do desenvolvimento e neuropsicológica.' }], encaminhamento: [{ texto: 'Equipe multidisciplinar (TO, fono, ABA).' }] }},
            'dislexia': { diagnosticos: [{ texto: 'Transtorno Específico da Aprendizagem com prejuízo na leitura (F81.0)' }], historiaInicial: { texto: 'Dificuldades persistentes na precisão, velocidade ou fluência da leitura, e na compreensão do lido, com desempenho abaixo do esperado para a idade.' }, exameFisico: { texto: 'Normal.' }, conduta: { terapiaMedicamentosa: [], examesSolicitados: [{ texto: 'Avaliação neuropsicológica e psicopedagógica.' }], encaminhamento: [{ texto: 'Psicopedagogo, fonoaudiólogo, apoio escolar.' }] }},
            'tod': { diagnosticos: [{ texto: 'Transtorno de Oposição Desafiante (F91.3)' }], historiaInicial: { texto: 'Padrão de humor raivoso/irritável, comportamento desafiante ou índole vingativa por ≥6 meses.\nSintomas: Perde a calma, discute com autoridade, recusa-se a obedecer, culpa os outros, é vingativo.' }, exameFisico: { texto: 'Normal.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Tratar comorbidades (TDAH).' }], examesSolicitados: [], encaminhamento: [{ texto: 'Psicologia/psiquiatria infantil, treinamento de pais, terapia familiar.' }] }},
            'insonia': { diagnosticos: [{ texto: 'Transtorno de Insônia (F51.0)' }], historiaInicial: { texto: 'Insatisfação com a quantidade/qualidade do sono (dificuldade inicial, de manutenção ou despertar precoce), causando prejuízo diurno.' }, exameFisico: { texto: 'Geralmente normal.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Não farmacológica (higiene do sono, TCC-I); se necessário, farmacológica (zolpidem).' }], examesSolicitados: [{ texto: 'PSG se houver suspeita de outros transtornos do sono.' }], encaminhamento: [{ texto: 'Especialista em sono ou psicólogo (TCC-I).' }] }},
            'sahos': { diagnosticos: [{ texto: 'Síndrome da Apneia e Hipopneia Obstrutiva do Sono (G47.3)' }], historiaInicial: { texto: 'Noturnos: Roncos altos, engasgos, pausas respiratórias.\nDiurnos: Sonolência excessiva, fadiga.\nOutros: Cefaleia matinal.' }, exameFisico: { texto: 'Fatores de risco: obesidade, pescoço largo, via aérea estreita, hipertensão. Exame neurológico normal.' }, conduta: { terapiaMedicamentosa: [{ texto: 'CPAP (padrão-ouro); perda de peso.' }], examesSolicitados: [{ texto: 'Polissonografia (PSG) (padrão-ouro).' }], encaminhamento: [{ texto: 'Especialista em sono.' }] }},
            'spi': { diagnosticos: [{ texto: 'Síndrome das Pernas Inquietas (G25.8)' }], historiaInicial: { texto: 'Diagnóstico clínico pelos 4 critérios: 1. Necessidade de mover as pernas com sensações desconfortáveis; 2. Piora com repouso; 3. Alívio com movimento; 4. Pior à noite.' }, exameFisico: { texto: 'Tipicamente normal.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Agentes dopaminérgicos.' }], examesSolicitados: [{ texto: 'Dosagem de ferritina sérica (essencial).' }], encaminhamento: [] }},
            'narcolepsia': { diagnosticos: [{ texto: 'Narcolepsia (G47.4)' }], historiaInicial: { texto: 'Tétrade clássica: 1. Sonolência Diurna Excessiva; 2. Cataplexia (perda de tônus muscular por emoções); 3. Alucinações hipnagógicas/hipnopômpicas; 4. Paralisia do Sono.' }, exameFisico: { texto: 'Normal.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Estimulantes para sonolência; antidepressivos para outros sintomas.' }], examesSolicitados: [{ texto: 'PSG seguida de Teste de Latências Múltiplas do Sono (TLMS).' }], encaminhamento: [{ texto: 'Centro de medicina do sono.' }] }},
            'sonambulismo': { diagnosticos: [{ texto: 'Transtorno do Despertar do Sono Não REM (F51.3)' }], historiaInicial: { texto: 'Episódios de deambulação durante o sono, no primeiro terço da noite, com amnésia posterior.\nIndivíduo tem olhar vago e é difícil de despertar.' }, exameFisico: { texto: 'Normal.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Medidas de segurança e higiene do sono; clonazepam em casos graves.' }], examesSolicitados: [{ texto: 'Vídeo-PSG para diagnóstico diferencial.' }], encaminhamento: [{ texto: 'Especialista em sono em casos atípicos/graves.' }] }},
            'epilepsiaFocal': { diagnosticos: [{ texto: 'Epilepsia Focal (G40.1)' }], historiaInicial: { texto: 'Crises originadas em um hemisfério cerebral, com manifestações motoras, sensitivas, autonômicas ou psíquicas, com ou sem perda de consciência.' }, exameFisico: { texto: 'Pode ser normal ou ter déficits focais relacionados à causa.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Fármacos antiepilépticos (carbamazepina, lamotrigina, etc.).' }], examesSolicitados: [{ texto: 'EEG e RM de encéfalo (protocolo de epilepsia).' }], encaminhamento: [{ texto: 'Centro de referência se farmacorresistente.' }] }},
            'epilepsiaGeneralizada': { diagnosticos: [{ texto: 'Epilepsia Generalizada (G40.3)' }], historiaInicial: { texto: 'Crises que rapidamente envolvem ambos hemisférios. Tipos: tônico-clônicas, ausência, mioclônicas.' }, exameFisico: { texto: 'Frequentemente normal.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Fármacos de amplo espectro (ácido valproico, lamotrigina).' }], examesSolicitados: [{ texto: 'EEG (descargas generalizadas) e RM (geralmente normal).' }], encaminhamento: [{ texto: 'Apenas em casos de difícil controle.' }] }},
            'cnep': { diagnosticos: [{ texto: 'Crises Não Epilépticas Psicogênicas (R56.8)' }], historiaInicial: { texto: 'Eventos de origem psicológica que simulam crises epilépticas.\nCaracterísticas: Início gradual, movimentos arrítmicos, olhos fechados com resistência à abertura, ausência de confusão pós-evento.' }, exameFisico: { texto: 'Normal no período intercrítico.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Psicoterapia. Descontinuar fármacos antiepilépticos.' }], examesSolicitados: [{ texto: 'Vídeo-EEG (padrão-ouro) para confirmar ausência de atividade epiléptica durante o evento.' }], encaminhamento: [{ texto: 'Mandatório para psiquiatria e psicologia.' }] }},
            sincopeVasovagal: { diagnosticos: [{ texto: 'Síncope Vasovagal (R55)' }], historiaInicial: { texto: 'Perda de consciência transitória com recuperação espontânea, associada a gatilhos (ortostase, estresse emocional) e precedida por pródromos (sudorese, tontura, náusea).\nA perda de consciência é breve (< 20s), podendo ocorrer abalos rítmicos. Ausência de cianose, perda de esfíncteres ou confusão pós-ictal prolongada.' }, exameFisico: { texto: 'Tipicamente normal no período intercrítico, sem déficits focais.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Medidas não farmacológicas. Orientar sobre a natureza benigna da condição e manobras de contrapressão (cruzar pernas) para abortar os episódios.' }], examesSolicitados: [{ texto: 'Não indicados em quadros típicos sem sinais de alarme.' }], encaminhamento: [{ texto: 'Sem indicação para quadros típicos.' }] }},
            vertigemCentral: { diagnosticos: [{ texto: 'Vertigem de Origem Central (H81.4)' }], historiaInicial: { texto: 'Vertigem ou desequilíbrio de início súbito (vascular) ou progressivo, frequentemente associada a outros sintomas neurológicos (diplopia, disartria, disfagia, fraqueza, dormência).\nSintomas auditivos são incomuns e a vertigem tende a ser constante e menos influenciada por movimentos da cabeça.' }, exameFisico: { texto: 'Nistagmo: Pode ser puramente vertical ou torcional, não é suprimido pela fixação visual e pode mudar de direção com o olhar.\nOutros Sinais: Provável presença de ataxia, paresia de nervos cranianos ou déficits motores/sensitivos.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Direcionada à causa subjacente (AVC, esclerose múltipla, tumor).' }], examesSolicitados: [{ texto: 'Ressonância Magnética (RM) de encéfalo de urgência é mandatória.' }], encaminhamento: [{ texto: 'Imediato para avaliação neurológica e internação hospitalar.' }] }},
            vertigemPeriferica: { diagnosticos: [{ texto: 'Vertigem Periférica (H81.3)' }], historiaInicial: { texto: 'Episódios de vertigem aguda, intensa e rotatória, podendo ser associada a sintomas auditivos unilaterais (zumbido, perda auditiva).\nPode ser desencadeada por movimentos específicos da cabeça (sugestivo de VPPB).\nAusência de sintomas neurológicos centrais.' }, exameFisico: { texto: 'Nistagmo: Geralmente misto (horizontal-torcional), unidirecional e suprimido pela fixação visual.\nTeste de Impulso Cefálico: Pode ser positivo, indicando disfunção vestibular.\nExame Neurológico Geral: Preservado.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Sintomáticos na fase aguda (anti-histamínicos). Para VPPB, manobras de reposicionamento. Reabilitação vestibular para casos persistentes.' }], examesSolicitados: [{ texto: 'Neuroimagem desnecessária em quadros típicos. Audiometria indicada se houver sintomas auditivos.' }], encaminhamento: [{ texto: 'Otorrinolaringologista ou fisioterapeuta especializado em reabilitação vestibular.' }] }},
            parestesiaCutanea: { diagnosticos: [{ texto: 'Parestesia Cutânea (R20.2)' }], historiaInicial: { texto: 'Queixa puramente sensitiva (formigamento, dormência, queimação) sem perda de força, com distribuição seguindo um padrão neuroanatômico (dermátomo, território de nervo ou "luvas e botas").' }, exameFisico: { texto: 'Motor: Força, tônus e reflexos preservados.\nSensitivo: Alteração da sensibilidade confinada à distribuição suspeita.\nSinais Irritativos: Pesquisar Lasègue ou Spurling se houver suspeita de radiculopatia.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Focada na causa base. Sintomáticos para dor neuropática (gabapentina, pregabalina).' }], examesSolicitados: [{ texto: 'Eletroneuromiografia (ENMG) é o exame de escolha. RM ou ultrassom de nervo para identificar causa estrutural.' }], encaminhamento: [{ texto: 'Fisioterapia. Ortopedista ou neurocirurgião, a depender da etiologia.' }] }},
            neuropatiaMetabolica: { diagnosticos: [{ texto: 'Neuropatia Metabólica (G63.*)' }], historiaInicial: { texto: 'Início insidioso e progressivo de sintomas sensitivos e/ou fraqueza muscular em padrão distal e simétrico ("luvas e botas").\nInvestigar histórico de doença renal, hipotireoidismo ou deficiências vitamínicas (B12).' }, exameFisico: { texto: 'Sensitivo: Perda sensitiva distal e simétrica (vibratória e propriocepção primeiro).\nMotor: Fraqueza e atrofia distal em casos avançados.\nReflexos: Hiporreflexia ou arreflexia (aquileus são os primeiros a serem abolidos).\nMarcha: Pode haver ataxia sensitiva, com piora ao fechar os olhos.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Controle rigoroso da doença de base e medicamentos para dor neuropática.' }], examesSolicitados: [{ texto: 'Laboratoriais para investigar a causa (função renal, tireoidiana, vitaminas). ENMG para confirmar e caracterizar a neuropatia.' }], encaminhamento: [{ texto: 'Endocrinologista ou clínico para manejo da condição de base.' }] }},
            neuropatiaDiabetica: { diagnosticos: [{ texto: 'Neuropatia Metabólica - Diabética (E10-E14† com G63.2*)' }], historiaInicial: { texto: 'Sintomas sensitivos nos pés (dor, queimação, dormência) com piora noturna.\nDocumentar tempo de diabetes e qualidade do controle glicêmico.\nInvestigar sintomas autonômicos (gastroparesia, hipotensão ortostática).' }, exameFisico: { texto: 'Sensitivo: Perda de sensibilidade em "bota". Avaliar com monofilamento de 10g.\nReflexos: Abolição dos reflexos aquileus é um achado precoce.\nInspeção dos Pés: Mandatória, buscando úlceras, calosidades, deformidades e anidrose.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Controle glicêmico rigoroso. Para dor: antidepressivos tricíclicos, gabapentinoides, etc.' }], examesSolicitados: [{ texto: 'Hemoglobina glicada. ENMG para confirmar e graduar a gravidade.' }], encaminhamento: [{ texto: 'Acompanhamento multidisciplinar (endocrinologista, podólogo, fisioterapeuta) e educação do paciente sobre autoinspeção dos pés.' }] }},
            miasteniaGravis: { diagnosticos: [{ texto: 'Miastenia Gravis (G70.0)' }], historiaInicial: { texto: 'Fraqueza muscular flutuante e fatigável, que piora com esforço e ao longo do dia, e melhora com repouso.\nPadrões comuns: Ocular (ptose, diplopia), Bulbar (disfagia, disartria), de Membros (proximal) ou Axial/Respiratória.' }, exameFisico: { texto: 'Focado em demonstrar a fatigabilidade com manobras específicas (sustentar olhar para cima, abduções repetidas dos braços). Sensibilidade e reflexos normais.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Inibidores da acetilcolinesterase (piridostigmina), imunossupressores (corticoides). Timectomia é fundamental, sendo mandatória com timoma.' }], examesSolicitados: [{ texto: 'Sorologia (anticorpos anti-AChR, anti-MuSK), ENMG com estimulação nervosa repetitiva e TC/RM de tórax para avaliar o timo.' }], encaminhamento: [{ texto: 'Neurologista especializado em doenças neuromusculares.' }] }},
            ela: { diagnosticos: [{ texto: 'Doença do Neurônio Motor - Esclerose Lateral Amiotrófica (ELA) (G12.2)' }], historiaInicial: { texto: 'Fraqueza muscular progressiva e indolor, de início focal (membro) ou bulbar (fala, deglutição), associada a fasciculações e cãibras.\nAusência de alterações sensitivas ou esfincterianas.' }, exameFisico: { texto: 'Coexistência de sinais de lesão do neurônio motor inferior (fraqueza, atrofia, fasciculações) e superior (hiperreflexia, espasticidade, Babinski).\nSensibilidade e motricidade ocular preservadas.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Riluzol pode retardar a progressão. O pilar do tratamento é o manejo de suporte multidisciplinar.' }], examesSolicitados: [{ texto: 'ENMG é fundamental. RM de crânio e coluna para excluir outras causas.' }], encaminhamento: [{ texto: 'Centro de referência multidisciplinar (neurologista, fisio, fono, nutricionista, pneumologista).' }] }},
            radiculopatiaCervical: { diagnosticos: [{ texto: 'Radiculopatia Cervical (M54.12)' }], historiaInicial: { texto: 'Dor cervical com irradiação para o membro superior, associada a parestesia em um dermátomo.\nPiora com movimentos do pescoço. Investigar sinais de alarme.' }, exameFisico: { texto: 'Pode haver hipoestesia em dermátomo, déficit de força em miótomo e/ou hiporreflexia correspondente. Teste de Spurling pode ser positivo.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Conservador com AINEs, analgésicos e fisioterapia.' }], examesSolicitados: [{ texto: 'RM de coluna cervical se os sintomas persistirem >4-6 semanas ou houver sinais de alarme.' }], encaminhamento: [{ texto: 'Fisioterapia. Ortopedista/neurocirurgião se houver falha no tratamento conservador ou mielopatia.' }] }},
            lombalgia: { diagnosticos: [{ texto: 'Lombalgia (M54.5)' }], historiaInicial: { texto: 'Dor lombar mecânica (inespecífica), sem irradiação abaixo do joelho, que piora com movimento e melhora com repouso.\nFocar na exclusão de sinais de alarme.' }, exameFisico: { texto: 'Exame neurológico dos membros inferiores normal. Manobra de Lasègue negativa.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Sintomático com AINEs/analgésicos. Incentivar manutenção das atividades. Fisioterapia e fortalecimento são a base do tratamento.' }], examesSolicitados: [{ texto: 'Não indicados nas primeiras 4-6 semanas sem sinais de alarme.' }], encaminhamento: [{ texto: 'Fisioterapia e reeducação postural.' }] }},
            lombociatalgia: { diagnosticos: [{ texto: 'Lombociatalgia (M54.4)' }], historiaInicial: { texto: 'Dor lombar que irradia para o membro inferior no trajeto de uma raiz nervosa (L4, L5, S1), associada a parestesias.' }, exameFisico: { texto: 'Teste de Lasègue positivo. Pesquisar déficits neurológicos correspondentes à raiz (fraqueza, hipoestesia, alteração de reflexo aquileu).' }, conduta: { terapiaMedicamentosa: [{ texto: 'AINEs, analgésicos, podendo-se associar corticoides (curso curto) ou medicamentos para dor neuropática.' }], examesSolicitados: [{ texto: 'RM de coluna lombar é o exame de escolha para confirmar a compressão.' }], encaminhamento: [{ texto: 'Fisioterapia. Ortopedista/neurocirurgião se houver dor refratária, déficit motor progressivo ou síndrome da cauda equina (emergência).' }] }},
            ccl: { diagnosticos: [{ texto: 'Comprometimento Cognitivo Leve (CCL) / Transtorno Neurocognitivo Leve (G31.84 / F06.7)' }], historiaInicial: { texto: 'Queixa subjetiva de declínio cognitivo sem interferência significativa na independência para atividades de vida diária. Não preenche critérios para demência.' }, exameFisico: { texto: 'Exame elementar normal. Avaliação cognitiva (MEEM, MoCA) pode estar abaixo do esperado. Avaliação neuropsicológica formal demonstra declínio objetivo.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Não há tratamento medicamentoso aprovado. Foco no manejo de fatores de risco vasculares e estímulo a atividades físicas, cognitivas e sociais.' }], examesSolicitados: [{ texto: 'Laboratoriais para excluir causas reversíveis (tireoide, B12). RM de encéfalo.' }], encaminhamento: [{ texto: 'Acompanhamento neurológico regular (6-12 meses).' }] }},
            alzheimer: { diagnosticos: [{ texto: 'Doença de Alzheimer (Provável) / Transtorno Neurocognitivo Maior Devido à Doença de Alzheimer (G30.9 + F00.1*)' }], historiaInicial: { texto: 'Início insidioso e progressão gradual de déficits cognitivos, com perda de memória episódica recente como sintoma cardinal.\nCom a progressão, afeta outros domínios (linguagem, função executiva), levando à perda da independência.' }, exameFisico: { texto: 'Exame elementar normal nas fases iniciais. Avaliação neuropsicológica confirma padrão de demência amnéstica que se torna multidomínio.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Sintomático com Inibidores da acetilcolinesterase e/ou Memantina.' }], examesSolicitados: [{ texto: 'RM de encéfalo para avaliar atrofia e excluir outras causas. Laboratoriais para afastar causas reversíveis.' }], encaminhamento: [{ texto: 'Abordagem multidisciplinar e suporte para cuidadores.' }] }},
            demenciaVascular: { diagnosticos: [{ texto: 'Demência Vascular (Provável) / Transtorno Neurocognitivo Vascular Maior (I60-I69† com F01.*)' }], historiaInicial: { texto: 'Declínio cognitivo temporalmente relacionado a evento(s) cerebrovascular(es), com curso "em degraus".\nPredomínio de disfunção executiva e múltiplos fatores de risco vascular.' }, exameFisico: { texto: 'Comum a presença de sinais neurológicos focais e distúrbio da marcha.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Prevenção secundária de novos eventos cerebrovasculares, com controle rigoroso de fatores de risco.' }], examesSolicitados: [{ texto: 'Neuroimagem (TC ou RM) é essencial para demonstrar as lesões vasculares.' }], encaminhamento: [{ texto: 'Acompanhamento conjunto com cardiologista/clínico.' }] }},
            demenciaLewy: { diagnosticos: [{ texto: 'Demência com Corpos de Lewy (Provável) / Transtorno Neurocognitivo Maior por Doença de Corpos de Lewy (G31.83 + F02.8*)' }], historiaInicial: { texto: 'Declínio cognitivo progressivo com flutuações de atenção, alucinações visuais recorrentes e parkinsonismo espontâneo.\nCaracterísticas sugestivas: Transtorno Comportamental do Sono REM (TCSREM) e sensibilidade a neurolépticos.' }, exameFisico: { texto: 'Combinação de déficits cognitivos (atenção, função executiva, visuoespacial) e parkinsonismo.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Inibidores da acetilcolinesterase (1ª linha). Levodopa com cautela. Evitar neurolépticos típicos. Clonazepam para TCSREM.' }], examesSolicitados: [{ texto: 'RM de encéfalo.' }], encaminhamento: [{ texto: 'Abordagem multidisciplinar com neurologista especializado.' }] }},
            demenciaFrontotemporal: { diagnosticos: [{ texto: 'Demência Fronto-temporal (Variante Comportamental - Provável) / Transtorno Neurocognitivo Maior Frontotemporal (G31.0 + F02.0*)' }], historiaInicial: { texto: 'Mudança progressiva na personalidade e comportamento (desinibição, apatia, perda de empatia, compulsões, hiperoralidade) com pouca percepção do paciente.\nPredomínio de disfunção executiva.' }, exameFisico: { texto: 'Exame elementar pode ser normal por longo período. Avaliação neuropsicológica confirma grave prejuízo executivo.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Manejo dos distúrbios de comportamento (ISRS podem ser úteis).' }], examesSolicitados: [{ texto: 'RM de encéfalo pode evidenciar atrofia fronto-temporal.' }], encaminhamento: [{ texto: 'Suporte e orientação aos cuidadores são essenciais.' }] }},
            tremorEssencial: { diagnosticos: [{ texto: 'Tremor Essencial (G25.0)' }], historiaInicial: { texto: 'Tremor cinético e postural, progressivo (> 3 anos), bilateral e simétrico, predominante nos membros superiores, podendo afetar cabeça e voz.\nAusência de outros sinais neurológicos (parkinsonismo, ataxia). História familiar pode ser positiva.' }, exameFisico: { texto: 'Tremor postural visível com braços estendidos e cinético durante a ação (prova dedo-nariz, escrita).\nAusência de tremor de repouso significativo, bradicinesia ou rigidez.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Propranolol' }, { texto: 'Primidona' }], examesSolicitados: [{ texto: 'Diagnóstico clínico. Em dúvida, SPECT (Trodat) pode ser útil (captação normal no estriado).' }], encaminhamento: [{ texto: 'Para casos refratários, avaliar terapias avançadas (toxina botulínica, DBS do núcleo VIM, HIFU).' }] }},
            doencaParkinson: { diagnosticos: [{ texto: 'Doença de Parkinson (G20)' }], historiaInicial: { texto: 'Início insidioso e assimétrico da tríade motora: tremor de repouso, bradicinesia e rigidez.\nPodem ocorrer sintomas não motores prodrômicos (hiposmia, constipação, transtorno comportamental do sono REM).' }, exameFisico: { texto: 'Tremor de repouso (4-6 Hz) que melhora com movimento; bradicinesia/hipocinesia; rigidez plástica ("roda denteada").\nHipomimia, redução do piscar, marcha festinada com balanço de braços reduzido. Instabilidade postural em fases avançadas.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Levodopa' }], examesSolicitados: [{ texto: 'RM de encéfalo para excluir causas secundárias. SPECT/PET pode confirmar a denervação dopaminérgica.' }], encaminhamento: [{ texto: 'Equipe multidisciplinar (fisioterapia, fono, TO). Em fases avançadas, avaliar para DBS.' }] }},
            parkinsonismoAtipicoGeral: { diagnosticos: [{ texto: 'Parkinsonismo Atípico (G23)' }], historiaInicial: { texto: 'Progressão rápida e simétrica dos sintomas.\nPresença de "red flags" precoces (quedas no primeiro ano, disautonomia grave, demência, paralisia do olhar).\nResposta pobre ou nula à Levodopa.' }, exameFisico: { texto: 'Além do parkinsonismo, presença de achados atípicos como ataxia, sinais piramidais (hiperreflexia, Babinski), mioclonias ou distonia.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Resposta à Levodopa insatisfatória. Tratamento primariamente de suporte e sintomático.' }], examesSolicitados: [{ texto: 'RM de encéfalo para identificar padrões de atrofia específicos.' }], encaminhamento: [{ texto: 'Equipe multidisciplinar para otimizar o manejo sintomático.' }] }},
            ams: { diagnosticos: [{ texto: 'Atrofia de Múltiplos Sistemas (AMS) (G90.3)' }], historiaInicial: { texto: 'Parkinsonismo associado a disautonomia grave e precoce (hipotensão ortostática, incontinência) e/ou síndrome cerebelar.\nSubtipos: AMS-P (parkinsoniana) ou AMS-C (cerebelar).' }, exameFisico: { texto: 'Parkinsonismo simétrico com resposta pobre à levodopa.\nSinais de disautonomia (queda da PA ortostática) e/ou disfunção cerebelar (ataxia, dismetria).' }, conduta: { terapiaMedicamentosa: [{ texto: 'Manejo sintomático da hipotensão ortostática e da bexiga neurogênica.' }], examesSolicitados: [{ texto: 'RM de encéfalo pode revelar atrofia do putâmen, ponte e cerebelo.' }], encaminhamento: [{ texto: 'Cardiologista/clínico para disautonomia e urologista para disfunção vesical.' }] }},
            psp: { diagnosticos: [{ texto: 'Paralisia Supranuclear Progressiva (PSP) (G23.1)' }], historiaInicial: { texto: 'Instabilidade postural com quedas frequentes no primeiro ano de doença.\nRigidez axial, disfagia, disartria espástica e alterações cognitivo-comportamentais.' }, exameFisico: { texto: 'Cardinal: paralisia supranuclear do olhar vertical para baixo.\nRigidez axial proeminente (retrocolo) e expressão facial de "espanto".' }, conduta: { terapiaMedicamentosa: [{ texto: 'Resposta à Levodopa pobre ou inexistente. Tratamento de suporte.' }], examesSolicitados: [{ texto: 'RM de encéfalo pode revelar atrofia seletiva do mesencéfalo.' }], encaminhamento: [{ texto: 'Fonoaudiologia (disfagia) e fisioterapia (prevenção de quedas) são cruciais.' }] }},
            distonia: { diagnosticos: [{ texto: 'Distonia (G24)' }], historiaInicial: { texto: 'Contrações musculares involuntárias e sustentadas, causando torção ou posturas anormais.\nClassificação: focal, segmentar, generalizada. Pode haver "truques sensoriais" de alívio.' }, exameFisico: { texto: 'Posturas distônicas visíveis, exacerbadas pela ação ("action dystonia").' }, conduta: { terapiaMedicamentosa: [{ texto: 'Teste com Levodopa em início precoce. Toxina botulínica é o tratamento de escolha para distonias focais.' }], examesSolicitados: [{ texto: 'RM de encéfalo para excluir causas secundárias. Testes genéticos em casos selecionados.' }], encaminhamento: [{ texto: 'Para casos refratários, avaliar para DBS (globo pálido interno).' }] }},
            distoniaCervical: { diagnosticos: [{ texto: 'Distonia Cervical (G24.3)' }], historiaInicial: { texto: 'Contrações involuntárias dos músculos do pescoço, resultando em posturas anormais da cabeça e dor.' }, exameFisico: { texto: 'Identificação da postura distônica e dos músculos envolvidos, que podem estar hipertrofiados. Pode haver tremor cefálico associado.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Aplicação de toxina botulínica nos músculos afetados é o tratamento de primeira linha.' }], examesSolicitados: [{ texto: 'Geralmente não necessários em casos típicos.' }], encaminhamento: [{ texto: 'Fisioterapia como adjuvante. Avaliar para DBS em casos graves e refratários.' }] }},
            doencaHuntington: { diagnosticos: [{ texto: 'Doença de Huntington (G10)' }], historiaInicial: { texto: 'Tríade: coreia, declínio cognitivo e sintomas psiquiátricos.\nHistória familiar com herança autossômica dominante.' }, exameFisico: { texto: 'Movimentos coreicos (rápidos, irregulares), impersistência motora, disfunção executiva e alterações de humor.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Sintomático. Coreia: tetrabenazina ou neurolépticos. Sintomas psiquiátricos: antidepressivos/estabilizadores de humor.' }], examesSolicitados: [{ texto: 'Confirmação por teste genético (expansão CAG no gene HTT). RM pode mostrar atrofia do núcleo caudado.' }], encaminhamento: [{ texto: 'Aconselhamento genético e manejo multidisciplinar são fundamentais.' }] }},
            coreiaSydenham: { diagnosticos: [{ texto: 'Coreia de Sydenham (I02)' }], historiaInicial: { texto: 'Início subagudo de coreia em criança/adolescente como manifestação de febre reumática, após infecção estreptocócica.\nSintomas neuropsiquiátricos associados (labilidade emocional, TOC).' }, exameFisico: { texto: 'Coreia, hipotonia muscular e "sinal do ordenhador".' }, conduta: { terapiaMedicamentosa: [{ texto: 'Antibioticoterapia para febre reumática. Sintomático para coreia com neurolépticos ou ácido valproico.' }], examesSolicitados: [{ texto: 'Investigação para infecção estreptocócica (ASLO) e ecocardiograma para avaliar cardite.' }], encaminhamento: [{ texto: 'Acompanhamento conjunto com cardiologista pediátrico e/ou reumatologista.' }] }},
            ataxiaCerebelar: { diagnosticos: [{ texto: 'Ataxia Cerebelar (R27.0)' }], historiaInicial: { texto: 'Queixa de incoordenação, desequilíbrio, instabilidade da marcha e fala "arrastada" (disartria cerebelar).' }, exameFisico: { texto: 'Dismetria (provas dedo-nariz, calcanhar-joelho), disdiadococinesia e marcha atáxica.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Direcionada à causa subjacente. Fisioterapia e reabilitação são pilares do manejo.' }], examesSolicitados: [{ texto: 'RM de encéfalo é mandatório. Testes laboratoriais e genéticos guiados pela suspeita clínica.' }], encaminhamento: [{ texto: 'A depender da etiologia, para investigação especializada (genética, reumatologia, oncologia).' }] }},
            ataxiaHereditaria: { diagnosticos: [{ texto: 'Ataxia Hereditária (G11)' }], historiaInicial: { texto: 'Início insidioso e progressivo de ataxia, com história familiar positiva. O padrão de herança guia a investigação.' }, exameFisico: { texto: 'Além da síndrome cerebelar, presença de achados associados é crucial (neuropatia, piramidalismo, oftalmoplegia, retinopatia, parkinsonismo).' }, conduta: { terapiaMedicamentosa: [{ texto: 'Tratamento de suporte e sintomático. Fisioterapia, TO e fonoaudiologia são essenciais.' }], examesSolicitados: [{ texto: 'Diagnóstico definitivo por testes genéticos.' }], encaminhamento: [{ texto: 'Aconselhamento genético para o paciente e familiares.' }] }},
            avciDireito: { diagnosticos: [{ texto: 'AVCi em território de [p. ex., Artéria Cerebral Média Direita] (I63)' }], historiaInicial: { texto: 'Início súbito de hemiparesia/hemiplegia e hemi-hipoestesia à esquerda, associado a heminegligência espacial e anosognosia.' }, exameFisico: { texto: 'Hemiparesia/hemiplegia esquerda com sinais piramidais. Heminegligência e extinção ao duplo estímulo.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Fase aguda: avaliar para trombólise IV (<4.5h) e/ou trombectomia mecânica (<24h). Prevenção secundária: antiagregação, estatina e controle de fatores de risco.' }], examesSolicitados: [{ texto: 'TC de crânio sem contraste na emergência; Angio-TC para avaliar oclusão de grande vaso.' }], encaminhamento: [{ texto: 'Reabilitação precoce e intensiva.' }] }},
            avciEsquerdo: { diagnosticos: [{ texto: 'AVCi em território de [p. ex., Artéria Cerebral Média Esquerda] (I63)' }], historiaInicial: { texto: 'Início súbito de hemiparesia/hemiplegia e hemi-hipoestesia à direita, com presença marcante de afasia.' }, exameFisico: { texto: 'Hemiparesia/hemiplegia direita com sinais piramidais. Classificar o tipo de afasia.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Diretrizes para fase aguda e prevenção secundária são as mesmas do AVCi de hemisfério direito.' }], examesSolicitados: [{ texto: 'Protocolo de imagem é o mesmo do AVCi de hemisfério direito.' }], encaminhamento: [{ texto: 'Reabilitação multidisciplinar, com ênfase na fonoaudiologia.' }] }},
            ait: { diagnosticos: [{ texto: 'Ataque Isquêmico Transitório (AIT) (G45.9)' }], historiaInicial: { texto: 'Episódio transitório (< 1h) de disfunção neurológica focal, com resolução completa e sem infarto na imagem.' }, exameFisico: { texto: 'Normal no momento da avaliação.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Emergência médica. Iniciar prevenção secundária imediata: dupla antiagregação (21 dias em alto risco) e estatina.' }], examesSolicitados: [{ texto: 'Investigação de urgência da etiologia (RM, imagem de vasos, ecocardiograma, Holter).' }], encaminhamento: [{ texto: 'Avaliação neurológica urgente para estratificação de risco (escore ABCD2).' }] }},
            avch: { diagnosticos: [{ texto: 'Hemorragia Intraparenquimatosa [localização] (I61)' }], historiaInicial: { texto: 'Início súbito de déficit focal, com cefaleia intensa, náuseas/vômitos e rebaixamento do nível de consciência. HAS é o principal fator de risco.' }, exameFisico: { texto: 'Déficit neurológico correspondente à localização. Avaliar nível de consciência (Glasgow) e sinais de HIC.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Controle pressórico rigoroso (PAS <140 mmHg) e manejo da hipertensão intracraniana.' }], examesSolicitados: [{ texto: 'TC de crânio sem contraste é o exame de escolha.' }], encaminhamento: [{ texto: 'Avaliação neurocirúrgica de urgência.' }] }},
            hsa: { diagnosticos: [{ texto: 'Hemorragia Subaracnóidea Aneurismática (I60)' }], historiaInicial: { texto: 'Cefaleia "em trovoada" (súbita, intensidade máxima, "pior da vida"). Pode haver perda de consciência e fotofobia.' }, exameFisico: { texto: 'Rigidez de nuca e sinais de irritação meníngea (Kernig, Brudzinski). Graduar por escalas (Hunt-Hess).' }, conduta: { terapiaMedicamentosa: [{ texto: 'UTI. Nimodipina para prevenção de vasoespasmo. Planejar tratamento definitivo do aneurisma (clipagem/embolização).' }], examesSolicitados: [{ texto: 'TC de crânio. Se negativa com alta suspeita, punção lombar. Angio-TC ou angiografia para identificar aneurisma.' }], encaminhamento: [{ texto: 'Avaliação de urgência pela neurocirurgia e neurorradiologia intervencionista.' }] }},
            tvc: { diagnosticos: [{ texto: 'Trombose Venosa Cerebral (I67.6)' }], historiaInicial: { texto: 'Cefaleia (90%), crises epilépticas, déficits focais, HIC. Investigar fatores de risco (contraceptivos orais, puerpério, trombofilias).' }, exameFisico: { texto: 'Fundoscopia pode revelar papiledema. Déficits podem ser bilaterais.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Anticoagulação plena, mesmo com hemorragia venosa associada.' }], examesSolicitados: [{ texto: 'RM de encéfalo com venografia por ressonância magnética (Veno-RM) é o padrão-ouro.' }], encaminhamento: [{ texto: 'Investigação etiológica para trombofilias após fase aguda.' }] }},
            paralisiaBell: { diagnosticos: [{ texto: 'Paralisia de Bell (G51.0)' }], historiaInicial: { texto: 'Início agudo (horas a dias) de fraqueza unilateral de toda a hemiface, com ou sem dor retroauricular.' }, exameFisico: { texto: 'Paralisia facial periférica unilateral completa. Sinal de Bell presente.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Início precoce (<72h) de corticosteroides orais. Medidas de proteção ocular são fundamentais.' }], examesSolicitados: [{ texto: 'Diagnóstico clínico. Imagem apenas em casos atípicos.' }], encaminhamento: [{ texto: 'Fisioterapia motora facial.' }] }},
            herpesZoster: { diagnosticos: [{ texto: 'Herpes Zoster (B02)' }], historiaInicial: { texto: 'Dor/queimação em dermátomo, precedendo em dias erupção vesicular na mesma área.' }, exameFisico: { texto: 'Erupção vesicular unilateral em dermátomo. Investigar déficits neurológicos associados (fraqueza, Síndrome de Ramsay Hunt).' }, conduta: { terapiaMedicamentosa: [{ texto: 'Antivirais (<72h do início da erupção) e analgésicos.' }], examesSolicitados: [{ texto: 'Diagnóstico clínico.' }], encaminhamento: [{ texto: 'Acompanhamento para monitorar neuralgia pós-herpética.' }] }},
            nevralgiaPosHerpetica: { diagnosticos: [{ texto: 'Nevralgia Pós-Herpética (G53.0)' }], historiaInicial: { texto: 'Dor persistente (>3 meses) no dermátomo após Herpes Zoster. Dor em queimação com paroxismos lancinantes; alodinia é característica.' }, exameFisico: { texto: 'Pode haver cicatrizes. Exame sensitivo documenta alodinia e/ou hiperalgesia.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Controle da dor neuropática. Primeira linha: antidepressivos tricíclicos, gabapentinoides, adesivos de lidocaína.' }], examesSolicitados: [{ texto: 'Diagnóstico clínico.' }], encaminhamento: [{ texto: 'Clínica de dor em casos refratários.' }] }},
            emrr: { diagnosticos: [{ texto: 'Esclerose Múltipla (G35)' }], historiaInicial: { texto: 'Surtos neurológicos (disfunção focal >24h) com recuperação. Requer disseminação no tempo e espaço para diagnóstico.' }, exameFisico: { texto: 'Documentação de déficits objetivos (sinais piramidais, ataxia, nistagmo, oftalmoplegia internuclear, Lhermitte).' }, conduta: { terapiaMedicamentosa: [{ texto: 'Surto agudo: pulsoterapia com metilprednisolona. Longo prazo: terapias modificadoras da doença (TMDs).' }], examesSolicitados: [{ texto: 'RM de encéfalo e medula espinhal é o exame chave. LCR (bandas oligoclonais) e potenciais evocados podem auxiliar.' }], encaminhamento: [{ texto: 'Neurologista especialista e equipe de reabilitação.' }] }},
            emProgressiva: { diagnosticos: [{ texto: 'Esclerose Múltipla (G35)' }], historiaInicial: { texto: 'Progressão contínua da incapacidade neurológica (Primária) ou após fase remitente-recorrente (Secundária). Queixa principal é piora gradual da marcha.' }, exameFisico: { texto: 'Achado mais comum é uma paraparesia espástica progressiva.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Opções de TMDs limitadas. Foco no manejo sintomático e reabilitação.' }], examesSolicitados: [{ texto: 'RM pode mostrar menor atividade inflamatória e maior atrofia.' }], encaminhamento: [{ texto: 'Reabilitação multidisciplinar é o pilar do tratamento.' }] }},
            cis: { diagnosticos: [{ texto: 'Outra Doença Desmielinizante Aguda Disseminada Especificada (G37.8)' }], historiaInicial: { texto: 'Primeiro episódio clínico sugestivo de doença desmielinizante (>24h), como neurite óptica ou mielite transversa parcial.' }, exameFisico: { texto: 'Achados objetivos correspondentes à apresentação clínica.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Se RM mostrar alto risco de conversão para EM, o início precoce de uma TMD pode ser indicado.' }], examesSolicitados: [{ texto: 'RM de encéfalo é crucial para estratificação de risco.' }], encaminhamento: [{ texto: 'Acompanhamento neurológico para monitorar conversão para EM.' }] }},
            neuriteOptica: { diagnosticos: [{ texto: 'Neurite Óptica (H46)' }], historiaInicial: { texto: 'Perda visual monocular subaguda, com dor à movimentação ocular e discromatopsia.' }, exameFisico: { texto: 'Redução da acuidade visual, escotoma central e defeito pupilar aferente relativo. Fundoscopia normal (retrobulbar) ou com papilite.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Pulsoterapia com metilprednisolona acelera a recuperação visual.' }], examesSolicitados: [{ texto: 'RM de órbitas e encéfalo para confirmar inflamação e avaliar risco de EM.' }], encaminhamento: [{ texto: 'Investigação etiológica para EM ou NMOSD.' }] }},
            nmosd: { diagnosticos: [{ texto: 'Neuromielite Óptica (Doença de Devic) (G36.0)' }], historiaInicial: { texto: 'Surtos neurológicos graves, tipicamente neurite óptica (bilateral, má recuperação) e/ou mielite transversa longitudinalmente extensa (≥3 segmentos).' }, exameFisico: { texto: 'Déficits visuais severos e sinais de mielite transversa completa.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Surto agudo: pulsoterapia/plasmaférese. Manutenção: imunossupressores (rituximabe, azatioprina).' }], examesSolicitados: [{ texto: 'Anticorpo sérico anti-aquaporina-4 (AQP4-IgG) é o marcador diagnóstico central. RM de medula espinhal.' }], encaminhamento: [{ texto: 'Neurologista com experiência em doenças desmielinizantes.' }] }},
            mieliteTransversa: { diagnosticos: [{ texto: 'Mielite Transversa Aguda em Doença Desmielinizante do Sistema Nervoso Central (G37.3)' }], historiaInicial: { texto: 'Disfunção medular aguda/subaguda com fraqueza, nível sensitivo e disfunção esfincteriana.' }, exameFisico: { texto: 'Paraparesia/paraplegia, nível sensitivo claro, reflexos inicialmente abolidos evoluindo para hiperreflexia com Babinski.' }, conduta: { terapiaMedicamentosa: [{ texto: 'Pulsoterapia com metilprednisolona. Tratamento subsequente dependerá da etiologia.' }], examesSolicitados: [{ texto: 'RM de toda a coluna vertebral com contraste (urgente). LCR e sorologia ampla para buscar a etiologia.' }], encaminhamento: [{ texto: 'Reabilitação intensiva e investigação etiológica completa.' }] }},
        };
        
        // --- DECLARAÇÃO DE FUNÇÕES ---
        // Funções puras e de utilidade
        function getFormattedDate(timestamp) { const date = timestamp ? new Date(timestamp) : new Date(); return `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getFullYear()).slice(-2)}`; }
        function getPeriodoDoDia() { const hora = new Date().getHours(); if (hora < 12) return 'MANHÃ'; if (hora < 18) return 'TARDE'; return 'NOITE'; }
        function saveDataToLocal(key, data) { try { localStorage.setItem(key, JSON.stringify(data)); } catch (e) { console.error(`Falha ao salvar dados em ${key}:`, e); } }
        function loadDataFromLocal(key) { try { const data = localStorage.getItem(key); return data ? JSON.parse(data) : null; } catch (e) { console.error(`Falha ao carregar dados de ${key}:`, e); return null; } }
        function debounce(func, timeout = 500) { let timer; return (...args) => { clearTimeout(timer); timer = setTimeout(() => { func.apply(this, args); }, timeout); }; }
        function autoResizeTextarea(el) { if(el) { el.style.height = 'auto'; el.style.height = `${el.scrollHeight}px`; } }
        
        function getDadosPacientePadrao() {
            return {
                paciente: { nome: {texto: ""}, nascimento: { texto: "" }, acompanhante: "Não", ocupacao: {texto: ""} },
                diagnosticos: [], historiaInicial: {texto: ""}, 
                atual: {texto: ""}, 
                evolucaoHistorico: { texto: "" }, 
                isAISummary: false,
                historico: { comorbidades: [], cirurgiasHospitalizacoes: [], habitos: { etilismo: "Nega", tabagismo: "Nega" }},
                medicamentos: { usoAtual: [], usoPrevio: [] },
                complementares: [], exameFisico: {texto: ""},
                conduta: { terapiaMedicamentosa: [], examesSolicitados: [], encaminhamento: [], documentos: [] }
            };
        }

        function calcularIdade(dataNascimento) {
            if (!dataNascimento || !/^\d{2}\/\d{2}\/\d{4}$/.test(dataNascimento)) return null;
            try {
                const [dia, mes, ano] = dataNascimento.split('/').map(Number);
                const data = new Date(ano, mes - 1, dia);
                if (data.getFullYear() !== ano || data.getMonth() !== mes - 1 || data.getDate() !== dia) return null;
                let idade = new Date().getFullYear() - data.getFullYear();
                const m = new Date().getMonth() - data.getMonth();
                if (m < 0 || (m === 0 && new Date().getDate() < data.getDate())) idade--;
                return idade >= 0 ? idade : null;
            } catch (e) { return null; }
        }

        function traduzirPosologia(codigo, form = 'comprimido') {
            if (!codigo) return '';
            const partes = codigo.split('-').map(p => parseFloat(p.replace(',', '.')));
            if (partes.length !== 3 || partes.some(isNaN)) return `Instrução: ${codigo}`;
            const [manha, tarde, noite] = partes;
            const instrucoes = [];
            const plural = (q) => (q > 1 ? 's' : '');
            const formatQuantidade = (q) => (q === 0.5) ? `0,5 (meio) ${form}` : `${q} ${form}${plural(q)}`;
            if (manha > 0) instrucoes.push(`${formatQuantidade(manha)} de manhã`);
            if (tarde > 0) instrucoes.push(`${formatQuantidade(tarde)} a tarde`);
            if (noite > 0) instrucoes.push(`${formatQuantidade(noite)} a noite`);
            let detalhe = '';
            if (noite > 0 && manha === 0 && tarde === 0) return `Tome ${formatQuantidade(noite)}, antes de dormir`;
            if (codigo === '1-0-0') detalhe = "após o café da manhã";
            if (codigo === '1-0-1') detalhe = "(a cada 12 horas)";
            if (codigo === '1-1-1') detalhe = "(de 8/8h)";
            return `Tome ${instrucoes.join(' e ')} ${detalhe}`.trim();
        }

        function gerarReceita(textoTerapia) {
            if (!textoTerapia || !textoTerapia.trim()) return [];
            const linhas = textoTerapia.trim().split('\n').filter(Boolean);
            
            return linhas.flatMap(linha => {
                const chave = linha.trim().toLowerCase();
                const receitaEspecial = StaticData.RECEITAS_ESPECIAIS[chave];
                
                if (receitaEspecial) {
                    if (receitaEspecial.multiplos) {
                        return receitaEspecial.multiplos.map((subReceita, index) => ({
                            title: `${chave.replace(/\b\w/g, c => c.toUpperCase())} (${index + 1}/${receitaEspecial.multiplos.length})`,
                            content: `${subReceita.uso}\n\n${subReceita.medicamento.padEnd(50, '-')} ${subReceita.quantidade}\n${subReceita.instrucoes.join('\n')}`
                        }));
                    }
                    return {
                        title: chave.replace(/\b\w/g, c => c.toUpperCase()),
                        content: `${receitaEspecial.uso}\n\n${receitaEspecial.medicamento.padEnd(50, '-')} ${receitaEspecial.quantidade}\n${receitaEspecial.instrucoes.join('\n')}`
                    };
                }

                const regex = /^(.+?)\s+(\d+(\.\d+)?\s?(mg|ml|ui|g|mcg|UI))\s*([\d,-]+)?/i;
                const match = linha.match(regex);
                
                if (match) {
                    const [, nomeSubstancia, dosagem, , , posologia] = match;
                    const nomeTrimmed = nomeSubstancia.trim().toLowerCase();
                    const mapEntry = StaticData.MEDICAMENTO_MAP[nomeTrimmed] || {};
                    const nomeRef = typeof mapEntry === 'string' ? mapEntry : mapEntry.ref || '';
                    const form = mapEntry.form || 'comprimido';
                    
                    const nomeCompleto = `${nomeSubstancia.trim()} ${nomeRef} ${dosagem.trim()}`.trim();
                    const instrucao = posologia ? traduzirPosologia(posologia, form) : `Tome 1 ${form} ao dia`;
                    
                    let quantidade = 60;
                    if (posologia) {
                        const dosesDia = posologia.split('-').reduce((sum, p) => sum + parseFloat(p.replace(',', '.')), 0);
                        if(dosesDia > 0) quantidade = Math.ceil(dosesDia * 30) * (dosesDia > 3 ? 1 : 2);
                    }
                    
                    return {
                        title: nomeCompleto.replace(/\b\w/g, c => c.toUpperCase()),
                        content: `USO ORAL E CONTÍNUO\n\n${nomeCompleto.padEnd(50, '-')} ${quantidade} ${form}${quantidade > 1 ? 's' : ''}\n${instrucao}`
                    };
                }
                
                return { title: 'Instrução Manual/Não Reconhecida', content: linha };
            });
        }

        function formatarTextoCapitalizado(texto) {
            if (!texto || texto.trim().length < 5) return texto;
            const letras = texto.match(/[a-zA-Zà-üÀ-Ü]/g) || [];
            const maiusculas = texto.match(/[A-ZÀ-Ü]/g) || [];
            if (letras.length > 0 && (maiusculas.length / letras.length > 0.7)) {
                let textoFormatado = texto.toLowerCase();
                textoFormatado = textoFormatado.replace(/(^ *[a-zà-ü]|(?<=\n) *[a-zà-ü])/g, c => c.toUpperCase());
                return textoFormatado.replace(StaticData.SIGLAS_REGEX, match => match.toUpperCase());
            }
            return texto;
        }

        function handleCopyClick(button, textProvider) {
            if (!button || button.dataset.copying) return;
            button.dataset.copying = 'true';
            const originalText = button.textContent;
            const originalClasses = button.className;
            const text = textProvider();
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position = "absolute";
            ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.select();
            try {
                document.execCommand('copy');
                button.textContent = 'Copiado!';
                button.className = originalClasses.replace(/btn-primary|btn-secondary|bg-red-600/g, '') + ' bg-green-600';
            } catch (err) {
                console.error('Falha ao copiar:', err);
                button.textContent = 'Erro!';
                button.className = originalClasses.replace(/btn-primary|btn-secondary|bg-green-600/g, '') + ' bg-red-600';
            } finally {
                document.body.removeChild(ta);
                setTimeout(() => {
                    button.textContent = originalText;
                    button.className = originalClasses;
                    delete button.dataset.copying;
                }, 2000);
            }
        }
        function renderDynamicContainer({ containerId, copyAllBtnId, items, renderItemHTML, emptyMessage }) {
            const container = document.getElementById(containerId);
            const copyAllBtn = document.getElementById(copyAllBtnId);
            if (!container || !copyAllBtn) return;
            if (!items || items.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center">${emptyMessage}</p>`;
                copyAllBtn.style.display = 'none';
            } else {
                container.innerHTML = items.map(renderItemHTML).join('');
                copyAllBtn.style.display = 'flex';
            }
        }
        function toggleCollapsible(header, stateObject, storageKey) {
            const id = header.dataset.sectionId || header.dataset.subsectionId;
            const content = header.nextElementSibling;
            if (content?.classList.contains('collapsible-content')) {
                header.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
                if (id) {
                    stateObject[id] = header.classList.contains('collapsed');
                    saveDataToLocal(storageKey, stateObject);
                }
            }
        }
        function showSaveStatus(message = 'Salvo!', success = true) {
            const statusEl = document.getElementById('save-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.classList.toggle('text-green-600', success);
                statusEl.classList.toggle('text-red-600', !success);
                statusEl.classList.remove('opacity-0');
                setTimeout(() => { statusEl.classList.add('opacity-0'); }, 3000);
            }
        }

        // --- Funções de Lógica da Aplicação ---
        
        async function analisarInformacoes() {
            const spinner = document.getElementById('analise-spinner');
            const textoEl = document.getElementById('textarea-informacoes');
            const texto = textoEl.value;
            if (texto.trim().toLowerCase() === 'novo') { resetApp(); return; }
            if (!texto.trim()) return;
            
            spinner.classList.remove('hidden');

            try {
                const aiData = await analisarComIA(texto);
                if (aiData) {
                    dadosAnalisados = { ...aiData };
                    const dadosForm = coletarDadosDoFormulario();
                    const mergeArrays = (arr1, arr2) => [...new Set([...arr1.map(i => i.texto), ...arr2])].map(t => ({texto: t}));
                    
                    dadosForm.historiaInicial.texto = dadosForm.historiaInicial.texto || aiData.historiaInicial || '';
                    dadosForm.historico.comorbidades = mergeArrays(dadosForm.historico.comorbidades, aiData.historico?.comorbidades || []);
                    dadosForm.medicamentos.usoAtual = mergeArrays(dadosForm.medicamentos.usoAtual, aiData.medicamentos?.usoAtual || []);
                    
                    renderizarFormulario(dadosForm);
                    textoEl.value = '';
                    autoResizeTextarea(textoEl);
                    showSaveStatus("Dados analisados!", true);
                } else {
                    showSaveStatus("Erro na análise.", false);
                }
            } catch(error) {
                console.error("Falha na análise com IA:", error);
                showSaveStatus("Erro na análise.", false);
            } finally {
                spinner.classList.add('hidden');
            }
        }

        function coletarDadosDoFormulario() {
            const currentState = loadDataFromLocal(DATA_STORAGE_KEY) || getDadosPacientePadrao();
            
            const coletarDadosInput = (id) => ({ texto: document.getElementById(id)?.value.trim() || "" });
            const coletarDadosTextarea = (id) => document.getElementById(id)?.value.split('\n').filter(Boolean).map(line => ({ texto: line.trim() })) || [];
            const getToggleValue = (name) => {
                const container = document.querySelector(`[data-toggle-container="${name}"]`);
                if (container?.querySelector('[data-value="sim"]')?.classList.contains('active')) {
                    const detail = container.querySelector('input[type="text"]')?.value.trim();
                    return detail || 'Sim';
                }
                return name === 'acompanhante' ? 'Não' : 'Nega';
            };

            currentState.paciente = {
                nome: coletarDadosInput('paciente-nome'),
                nascimento: coletarDadosInput('paciente-nascimento'),
                acompanhante: getToggleValue('acompanhante'),
                ocupacao: coletarDadosInput('paciente-ocupacao'),
            };
            currentState.diagnosticos = coletarDadosTextarea('textarea-diagnosticos');
            currentState.historiaInicial = coletarDadosInput('historia-inicial');
            currentState.atual = coletarDadosInput('atual');
            currentState.historico = {
                comorbidades: coletarDadosTextarea('textarea-comorbidades'),
                cirurgiasHospitalizacoes: coletarDadosTextarea('cirurgias-hospitalizacoes'),
                habitos: { etilismo: getToggleValue('etilismo'), tabagismo: getToggleValue('tabagismo') }
            };
            currentState.medicamentos = {
                usoAtual: coletarDadosTextarea('textarea-medicamentos-atuais'),
                usoPrevio: coletarDadosTextarea('textarea-medicamentos-previos'),
            };
            currentState.complementares = coletarDadosTextarea('textarea-complementares');
            currentState.exameFisico = coletarDadosInput('exame-fisico');
            currentState.conduta = {
                terapiaMedicamentosa: coletarDadosTextarea('textarea-terapia'),
                examesSolicitados: coletarDadosTextarea('conduta-exames'),
                encaminhamento: coletarDadosTextarea('conduta-encaminhamento'),
                documentos: Array.from(document.querySelectorAll('#conduta-documentos-container input[type="checkbox"]:checked')).map(cb => {
                    const doc = { texto: cb.value };
                    if (cb.value === 'Atestado') doc.dias = document.getElementById('atestado-dias')?.value.trim() || '';
                    if (cb.value === 'Declaração') doc.acompanhante = document.getElementById('declaracao-acompanhante')?.value.trim() || '';
                    if (cb.value === 'Laudo') doc.tipoLaudo = document.querySelector('input[name="laudo-tipo"]:checked')?.value || 'Diagnóstico';
                    return doc;
                })
            };
            return currentState;
        }

        const debouncedUpdate = debounce((updatedState) => {
            if (isProgrammaticChange) return;
            const fullState = updatedState || coletarDadosDoFormulario();
            saveDataToLocal(DATA_STORAGE_KEY, fullState);
            updateAllPreviews(fullState);
            showSaveStatus();
        }, 500);

        function renderizarFormulario(dados) {
            isProgrammaticChange = true;
            const safeDados = { ...getDadosPacientePadrao(), ...dados,
                paciente: { ...getDadosPacientePadrao().paciente, ...(dados.paciente || {}) },
                historico: { ...getDadosPacientePadrao().historico, ...(dados.historico || {}), habitos: { ...getDadosPacientePadrao().historico.habitos, ...(dados.historico?.habitos || {}) } },
                medicamentos: { ...getDadosPacientePadrao().medicamentos, ...(dados.medicamentos || {}) },
                conduta: { ...getDadosPacientePadrao().conduta, ...(dados.conduta || {}) }
            };

            const arrayToText = (arr = []) => arr.map(item => item?.texto || '').filter(Boolean).join('\n');
            const inputToText = (obj) => obj?.texto || '';

            document.getElementById('paciente-nome').value = inputToText(safeDados.paciente.nome);
            document.getElementById('paciente-nascimento').value = inputToText(safeDados.paciente.nascimento);
            document.getElementById('paciente-ocupacao').value = inputToText(safeDados.paciente.ocupacao);
            document.getElementById('textarea-diagnosticos').value = arrayToText(safeDados.diagnosticos);
            document.getElementById('atual').value = inputToText(safeDados.atual);
            document.getElementById('textarea-comorbidades').value = arrayToText(safeDados.historico.comorbidades);
            document.getElementById('textarea-medicamentos-atuais').value = arrayToText(safeDados.medicamentos.usoAtual);
            document.getElementById('textarea-medicamentos-previos').value = arrayToText(safeDados.medicamentos.usoPrevio);
            document.getElementById('textarea-complementares').value = arrayToText(safeDados.complementares);
            document.getElementById('textarea-terapia').value = arrayToText(safeDados.conduta.terapiaMedicamentosa);
            document.getElementById('historia-inicial').value = inputToText(safeDados.historiaInicial);
            document.getElementById('exame-fisico').value = inputToText(safeDados.exameFisico);
            document.getElementById('cirurgias-hospitalizacoes').value = arrayToText(safeDados.historico.cirurgiasHospitalizacoes);
            document.getElementById('conduta-exames').value = arrayToText(safeDados.conduta.examesSolicitados);
            document.getElementById('conduta-encaminhamento').value = arrayToText(safeDados.conduta.encaminhamento);

            const setToggleValue = (name, value) => {
                const container = document.querySelector(`[data-toggle-container="${name}"]`); if (!container) return;
                const isSim = value && !/^(não|nega)$/i.test(String(value).trim());
                container.querySelector('[data-value="sim"]').classList.toggle('active', isSim);
                container.querySelector('[data-value="nao"]').classList.toggle('active', !isSim);
                const detailInput = container.querySelector('input[type="text"]');
                if (detailInput) {
                    const isCustomDetail = isSim && !['sim', 'não', 'nega'].includes(String(value).toLowerCase());
                    detailInput.classList.toggle('hidden', !isSim);
                    detailInput.value = isCustomDetail ? value : '';
                }
            };

            setToggleValue('acompanhante', safeDados.paciente.acompanhante);
            setToggleValue('etilismo', safeDados.historico.habitos.etilismo);
            setToggleValue('tabagismo', safeDados.historico.habitos.tabagismo);

            document.querySelectorAll('#conduta-documentos-container input[type="checkbox"]').forEach(cb => {
                const docData = (safeDados.conduta.documentos || []).find(d => d.texto === cb.value);
                cb.checked = !!docData;
                if (cb.id === 'checkbox-atestado') {
                    const input = document.getElementById('atestado-dias');
                    input.classList.toggle('hidden', !cb.checked);
                    input.value = cb.checked ? (docData?.dias || '') : '';
                }
                if (cb.id === 'checkbox-declaracao') {
                    const input = document.getElementById('declaracao-acompanhante');
                    input.classList.toggle('hidden', !cb.checked);
                    input.value = cb.checked ? (docData?.acompanhante || '') : '';
                }
                if (cb.id === 'checkbox-laudo') {
                    const a = document.getElementById('laudo-opcoes');
                    a.classList.toggle('hidden', !cb.checked);
                    if (cb.checked) {
                        const tipo = docData?.tipoLaudo || 'Diagnóstico';
                        const radio = document.querySelector(`input[name="laudo-tipo"][value="${tipo}"]`);
                        if (radio) radio.checked = true;
                    }
                }
            });

            document.querySelectorAll('textarea').forEach(autoResizeTextarea);
            isProgrammaticChange = false;
            debouncedUpdate(safeDados);
        }

        // --- Funções de Mocks de IA ---
        const simularLatencia = () => new Promise(resolve => setTimeout(resolve, 800));
        async function separarDiagnosticosComIA(texto) { await simularLatencia(); if (/cefaleia|enxaqueca/i.test(texto)) return ["Migrânea sem Aura (G43.0)", "Cefaleia Tensional (G44.2)"]; if (/parkinson/i.test(texto)) return ["Doença de Parkinson (G20)"]; return [texto]; }
        async function gerarCidComIA(diagnostico) { await simularLatencia(); const cids={'migrânea':'G43.0','cefaleia':'R51','tensional':'G44.2','parkinson':'G20','depressivo':'F33.9','ansiedade':'F41.1','tdah':'F90.0','tea':'F84.0'}; const match=Object.keys(cids).find(key=>diagnostico.toLowerCase().includes(key)); return match?cids[match]:null; }
        async function analisarComIA(texto) { await simularLatencia(); if (/cefaleia/i.test(texto) && /losartana/i.test(texto)) { return { historiaInicial: "Paciente em acompanhamento por migrânea. Apresenta 3 episódios/semana de forte intensidade.", historico: { comorbidades: ["HAS"] }, medicamentos: { usoAtual: ["Losartana 50mg 1-0-0", "Topiramato 50mg 0-0-1"] }}; } return { historiaInicial: "Não foi possível extrair a história.", historico: { comorbidades: [] }, medicamentos: { usoAtual: [] } }; }
        async function gerarResumoComIA(texto) { await simularLatencia(); if (/migrânea/i.test(texto)) return "Migrânea com piora na frequência."; if (/sono/i.test(texto)) return "Insônia crônica."; return "Resumo gerado pela IA."; }

        // --- Funções de Geração de Texto ---
        // Funções de geração de texto (Evolução, Documentos, etc.)

        function buildCurrentEvolutionLine(dados, timestamp) {
            let resumoTexto = dados.atual?.texto?.trim();
            if (!resumoTexto) return '';
            const isFirstEntry = !dados.evolucaoHistorico?.texto?.trim();
            if (isFirstEntry && dados.isAISummary) resumoTexto = "Consulta inicial com " + resumoTexto;
            const condutaResumo = [
                (dados.conduta.terapiaMedicamentosa || []).length > 0 ? `Prescrito medicação` : null,
                (dados.conduta.examesSolicitados || []).some(c => c.texto.trim()) ? "Solicitado exames" : null,
                (dados.conduta.encaminhamento || []).some(c => c.texto.trim()) ? "Encaminhado" : null,
                (dados.conduta.documentos || []).length > 0 ? `Fornecido ${dados.conduta.documentos.map(d => d.texto).join(', ')}` : null
            ].filter(Boolean).join(', ');
            return `- ${getFormattedDate(timestamp)} - ${resumoTexto}. [${condutaResumo || 'Conduta'}]`;
        }
        
        function gerarEvolucao(dados, timestamp) {
            if (!dados?.paciente) return "Dados do paciente inválidos.";
            const renderField = (item, defaultValue = '') => item?.texto?.trim() || defaultValue;
            
            const nomeOutput = `${renderField(dados.paciente.nome, 'Paciente')} (${calcularIdade(renderField(dados.paciente.nascimento)) || 'Idade N/A'} anos)`;
            const historiaFormatada = renderField(dados.historiaInicial, '[Descrição da queixa inicial]').split('\n').filter(p => p.trim()).map(p => `- ${p.trim()}`).join('\n');
            const diagnosticosFormatados = dados.diagnosticos?.map(d => d.texto.trim()).join('\n') || 'Nenhum diagnóstico informado';
            
            const historicoSalvo = renderField(dados.evolucaoHistorico);
            const linhaAtualPreview = buildCurrentEvolutionLine(dados, timestamp);
            const evolucaoCompleta = [historicoSalvo, linhaAtualPreview].filter(Boolean).join('\n');

            const formatArray = (arr, neg) => arr?.length > 0 ? arr.map(i => i.texto.trim()).join(', ') : neg;

            return `${nomeOutput}
- Acompanhante: ${dados.paciente.acompanhante || 'Não'}
- Ocupação: ${renderField(dados.paciente.ocupacao, 'Não informada')}

#Diagnóstico (CID)
${diagnosticosFormatados}

#História Inicial
${historiaFormatada}

#Evolução
${evolucaoCompleta || '- Nenhuma evolução registrada.'}

#Histórico
- Comorbidades: ${formatArray(dados.historico.comorbidades, 'Nega')}
- Cirurgia / Hospitalização: ${formatArray(dados.historico.cirurgiasHospitalizacoes, 'Nega')}
- Hábitos: Etilismo: ${dados.historico.habitos?.etilismo || 'Nega'}, Tabagismo: ${dados.historico.habitos?.tabagismo || 'Nega'}

#Medicamentos
- Uso atual: ${formatArray(dados.medicamentos.usoAtual, 'Nega')}
- Uso Prévio: ${formatArray(dados.medicamentos.usoPrevio, 'Nega')}

#Exames Complementares
${formatArray(dados.complementares, '- Sem exames atuais')}

#Exame Físico/Neurológico
- ${renderField(dados.exameFisico, 'Sem alterações')}

#Conduta
- Terapia: ${formatArray(dados.conduta.terapiaMedicamentosa, 'Sem nova terapia')}
- Exames: ${formatArray(dados.conduta.examesSolicitados, 'Sem indicação')}
- Encaminhamento: ${formatArray(dados.conduta.encaminhamento, 'Sem indicação')}
- Documentos: ${dados.conduta.documentos?.length > 0 ? dados.conduta.documentos.map(d => d.texto).join(', ') : 'Nenhum'}`;
        }
        
        function gerarDocumentos(dados) {
            const currentData = dados || coletarDadosDoFormulario();
            if (!currentData?.conduta?.documentos?.length) return [];
            
            const nomePaciente = currentData.paciente.nome?.texto?.toUpperCase() || '[PACIENTE]';
            const dataConsulta = new Date().toLocaleDateString('pt-BR');
            const diagnosticos = currentData.diagnosticos?.map(d => d.texto.trim()).join('; ') || '[Diagnóstico]';
            const renderField = (item, def = '') => item?.texto?.trim() || def;
            
            return currentData.conduta.documentos.map(doc => {
                const strategy = LaudoStrategies[doc.tipoLaudo] || LaudoStrategies['Diagnóstico'];
                let content = '';
                switch (doc.texto) {
                    case 'Atestado':
                        content = `ATESTADO MÉDICO\n\nAtesto que ${nomePaciente} esteve sob meus cuidados em ${dataConsulta}, necessitando de ${doc.dias || '[DIAS]'} dias de afastamento.\nCID-10: ${diagnosticos.match(/\((.*?)\)/)?.[1] || '[CID]'}${DocumentTemplates.ASSINATURA}`;
                        break;
                    case 'Declaração':
                        const paraQuem = doc.acompanhante ? `o(a) Sr(a). ${doc.acompanhante.toUpperCase()} como acompanhante de ${nomePaciente}` : `o(a) paciente ${nomePaciente}`;
                        content = `DECLARAÇÃO\n\nDeclaro que ${paraQuem} compareceu a esta consulta em ${dataConsulta}, no período da ${getPeriodoDoDia()}.${DocumentTemplates.ASSINATURA}`;
                        break;
                    case 'Orientações':
                        content = DocumentTemplates.ORIENTACOES_AVC.replace('[NOME_PACIENTE]', `Paciente: ${nomePaciente}`).replace('[DATA_CONSULTA]', dataConsulta);
                        break;
                    case 'Laudo':
                        content = strategy(currentData, nomePaciente, diagnosticos, DocumentTemplates.ASSINATURA, renderField);
                        break;
                }
                return { title: doc.texto, content };
            }).filter(d => d.content);
        }

        // --- Funções de Lógica Principal ---
        function updateAllPreviews(dados) {
            const currentData = dados || coletarDadosDoFormulario();
            document.getElementById('evolucao-output').innerHTML = gerarEvolucao(currentData, new Date().toISOString());

            renderDynamicContainer({
                containerId: 'receita-container', copyAllBtnId: 'btn-copiar-todas-receitas', items: gerarReceita(currentData.conduta.terapiaMedicamentosa.map(t => t.texto).join('\n')),
                renderItemHTML: (item) => `<div class="info-card !bg-white border p-4 copy-container"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold text-gray-800">${item.title}</h4><button class="btn btn-primary btn-copy-item font-semibold py-1 px-3">Copiar</button></div><pre class="preview-output !min-h-0">${item.content}</pre></div>`,
                emptyMessage: 'Nenhuma receita gerada.'
            });

            renderDynamicContainer({
                containerId: 'documentos-container', copyAllBtnId: 'btn-copiar-todos-documentos', items: gerarDocumentos(currentData),
                renderItemHTML: (item) => `<div class="info-card !bg-white border p-4 copy-container"><div class="flex justify-between items-center mb-2"><h4 class="font-semibold text-gray-800">${item.title}</h4><button class="btn btn-primary btn-copy-item font-semibold py-1 px-3">Copiar</button></div><pre class="preview-output !min-h-0">${item.content}</pre></div>`,
                emptyMessage: 'Nenhum documento selecionado.'
            });
        }
        
        function salvarConsulta() {
            const currentData = coletarDadosDoFormulario();
            const patientName = currentData.paciente.nome?.texto;
            if (!patientName) { showSaveStatus("Nome do paciente é obrigatório.", false); return; }

            const db = loadDataFromLocal(PACIENTES_DB_KEY) || {};
            let patientRecord = db[patientName] || getDadosPacientePadrao();
            
            Object.assign(patientRecord, currentData);

            const novaLinha = buildCurrentEvolutionLine(patientRecord, new Date().toISOString());
            if (novaLinha) {
                patientRecord.evolucaoHistorico.texto = [patientRecord.evolucaoHistorico.texto, novaLinha].filter(Boolean).join('\n');
            }
            
            patientRecord.atual = { texto: "" };
            patientRecord.isAISummary = false;

            db[patientName] = patientRecord;
            saveDataToLocal(PACIENTES_DB_KEY, db);
            
            renderizarFormulario(patientRecord);
            showSaveStatus("Consulta salva no histórico!", true);
        }

        function resetApp() {
            const btn = document.getElementById('btn-novo-paciente');
            if (!btn.dataset.confirming) {
                btn.dataset.confirming = 'true';
                btn.textContent = 'Confirma Limpar?';
                btn.classList.replace('btn-green', 'bg-red-500');
                setTimeout(() => {
                    delete btn.dataset.confirming;
                    btn.textContent = 'Novo Paciente';
                    btn.classList.replace('bg-red-500', 'btn-green');
                }, 3000);
                return;
            }
            localStorage.removeItem(DATA_STORAGE_KEY);
            dadosAnalisados = {};
            renderizarFormulario(getDadosPacientePadrao());
            showSaveStatus("Novo paciente pronto.", true);
            delete btn.dataset.confirming;
            btn.textContent = 'Novo Paciente';
            btn.classList.replace('bg-red-500', 'btn-green');
        }

        function loadPatientRecord(name) {
            if (isProgrammaticChange || !name) return;
            const db = loadDataFromLocal(PACIENTES_DB_KEY) || {};
            const record = db[name];
            if (record) {
                renderizarFormulario(record);
                showSaveStatus(`Histórico de ${name} carregado.`, true);
            }
        }
        
        function aplicarModelo(modeloKey) {
            const modelo = MODELOS_COMPLETOS[modeloKey];
            if (!modelo) {
                console.warn(`Modelo '${modeloKey}' não encontrado.`);
                return;
            }

            const currentData = coletarDadosDoFormulario();

            const mergeText = (currentText, newText) => {
                if (!newText) return currentText;
                const currentLines = new Set(currentText.split('\n').map(l => l.trim()).filter(Boolean));
                const newLines = newText.split('\n').map(l => l.trim()).filter(Boolean);
                newLines.forEach(line => currentLines.add(line));
                return Array.from(currentLines).join('\n');
            };
            
            const mergeArrayOfTextObjects = (currentArray, newArray) => {
                if (!newArray || newArray.length === 0) return currentArray;
                const currentTextSet = new Set(currentArray.map(item => item.texto.trim()));
                const uniqueNewItems = newArray.filter(item => !currentTextSet.has(item.texto.trim()));
                return [...currentArray, ...uniqueNewItems];
            };

            currentData.diagnosticos = mergeArrayOfTextObjects(currentData.diagnosticos, modelo.diagnosticos);
            currentData.historiaInicial.texto = mergeText(currentData.historiaInicial.texto, modelo.historiaInicial.texto);
            currentData.exameFisico.texto = mergeText(currentData.exameFisico.texto, modelo.exameFisico.texto);

            if (modelo.conduta) {
                currentData.conduta.terapiaMedicamentosa = mergeArrayOfTextObjects(currentData.conduta.terapiaMedicamentosa, modelo.conduta.terapiaMedicamentosa);
                currentData.conduta.examesSolicitados = mergeArrayOfTextObjects(currentData.conduta.examesSolicitados, modelo.conduta.examesSolicitados);
                currentData.conduta.encaminhamento = mergeArrayOfTextObjects(currentData.conduta.encaminhamento, modelo.conduta.encaminhamento);
            }

            renderizarFormulario(currentData);
            showSaveStatus(`Modelo '${modeloKey}' aplicado!`, true);
        }


        function renderHistoricoTab() {
            const db = loadDataFromLocal(PACIENTES_DB_KEY) || {};
            const allRecords = Object.entries(db).map(([name, data]) => ({ name, data })).sort((a, b) => a.name.localeCompare(b.name));
            const searchInput = document.getElementById('search-historico');
            const resultsContainer = document.getElementById('search-results-container');
            
            const renderResults = (records) => {
                resultsContainer.innerHTML = records.length === 0 
                    ? `<p class="text-center text-gray-500">Nenhum paciente encontrado.</p>`
                    : records.map(({name, data}) => {
                        const idade = calcularIdade(data.paciente.nascimento?.texto) || 'N/A';
                        const ultimaEvolucao = data.evolucaoHistorico?.texto?.split('\n').pop() || 'Nenhuma.';
                        return `
                            <div class="info-card !bg-white border p-4">
                                <div class="border-b pb-2 mb-2">
                                    <h4 class="font-bold text-blue-700">${name} (${idade} anos)</h4>
                                    <p class="text-gray-600 text-sm"><strong>Dx:</strong> ${data.diagnosticos?.map(d=>d.texto).join(', ') || 'N/A'}</p>
                                    <p class="text-gray-500 text-xs mt-1 truncate"><strong>Última:</strong> ${ultimaEvolucao.replace(/-\s+\d{2}\.\d{2}\.\d{2}\s+-\s+/, '')}</p>
                                </div>
                                <button class="btn btn-primary w-full py-1 mt-2 btn-load-patient" data-patient-name="${name}">Carregar Ficha</button>
                            </div>`;
                    }).join('');
            };
            
            searchInput.addEventListener('input', debounce(() => {
                const query = searchInput.value.toLowerCase().trim();
                const filtered = !query ? allRecords : allRecords.filter(({ name, data }) => 
                    name.toLowerCase().includes(query) ||
                    (data.diagnosticos || []).some(d => d.texto.toLowerCase().includes(query))
                );
                renderResults(filtered);
            }, 300));
            
            resultsContainer.addEventListener('click', (e) => {
                if (e.target.matches('.btn-load-patient')) {
                    const patientName = e.target.dataset.patientName;
                    loadPatientRecord(patientName);
                    document.querySelector('[data-tab-left="consulta"]').click();
                }
            });

            renderResults(allRecords);
        }

        // --- INICIALIZAÇÃO ---
        window.addEventListener('error', (event) => {
            const errorOverlay = document.getElementById('error-overlay');
            if (errorOverlay) return;
            document.body.insertAdjacentHTML('afterbegin', `
                <div id="error-overlay" class="fixed inset-0 bg-red-100 text-red-800 p-8 flex flex-col justify-center items-center text-center z-50">
                    <h1 class="text-2xl font-bold mb-4">Ocorreu um Erro Crítico</h1>
                    <p class="mb-6">A aplicação encontrou um problema. Para resolver, por favor, clique no botão abaixo para limpar os dados e recarregar.</p>
                    <button id="clear-data-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded hover:bg-red-700">Limpar Dados e Recarregar</button>
                </div>
            `);
            document.getElementById('clear-data-btn').addEventListener('click', () => {
                localStorage.clear();
                window.location.reload();
            });
        });
        
        document.addEventListener('DOMContentLoaded', () => {
             try {
                const initialData = loadDataFromLocal(DATA_STORAGE_KEY) || getDadosPacientePadrao();
                renderizarFormulario(initialData);
            } catch (error) {
                console.error("Falha na inicialização, disparando recuperação de erro:", error);
                window.dispatchEvent(new ErrorEvent('error', { error }));
                return;
            }
            
            const formContainer = document.getElementById('form-container');
            let collapsibleState = loadDataFromLocal(COLLAPSIBLE_STATE_KEY) || { 'dados': true, 'atual': true, 'complementares': true, 'exame-fisico': true };
            let collapsibleSubState = loadDataFromLocal(COLLAPSIBLE_SUB_STATE_KEY);

            // Se não houver estado salvo, define o padrão com os modelos minimizados
            if (collapsibleSubState === null) {
                collapsibleSubState = {
                    'identificacao-detalhes': true, 'cirurgias': true, 'habitos': true, 'uso-previo': true,
                    'conduta-exames': true, 'conduta-encaminhamento': true, 'conduta-documentos': true,
                    // Garantir que todos os modelos de diagnóstico comecem minimizados
                    'modelos-main': true,
                    'modelo-cefaleia': true,
                    'modelo-humor': true,
                    'modelo-neurodivergencia': true,
                    'modelo-sono': true,
                    'modelo-epilepsia': true,
                    'modelo-sincope': true,
                    'modelo-nervo': true,
                    'modelo-neuromuscular': true,
                    'modelo-coluna': true,
                    'modelo-cognicao': true,
                    'modelo-movimento': true,
                    'modelo-cerebrovascular': true,
                    'modelo-inflamatorias': true,
                    'modelo-desmielinizantes': true
                };
                saveDataToLocal(COLLAPSIBLE_SUB_STATE_KEY, collapsibleSubState);
            }

            const applyCollapseState = (selector, stateObject) => {
                document.querySelectorAll(selector).forEach(header => {
                    const id = header.dataset.sectionId || header.dataset.subsectionId;
                    if (id && stateObject[id]) {
                        header.classList.add('collapsed');
                        const content = header.nextElementSibling;
                        if (content?.classList.contains('collapsible-content')) content.classList.add('collapsed');
                    }
                });
            };
            
            applyCollapseState('.collapsible-header', collapsibleState);
            applyCollapseState('.collapsible-subheader', collapsibleSubState);

            formContainer.addEventListener('click', (e) => {
                const modelBtn = e.target.closest('.model-btn');
                if (modelBtn) {
                    const modeloKey = modelBtn.dataset.modelo;
                    if(modeloKey) aplicarModelo(modeloKey);
                    return; 
                }
                const header = e.target.closest('.collapsible-header, .collapsible-subheader');
                if (header && !e.target.closest('button')) {
                    const isSub = header.classList.contains('collapsible-subheader');
                    toggleCollapsible(header, isSub ? collapsibleSubState : collapsibleState, isSub ? COLLAPSIBLE_SUB_STATE_KEY : COLLAPSIBLE_STATE_KEY);
                }
            });

            document.getElementById('left-column-content-wrapper').addEventListener('input', (e) => {
                if (e.target.tagName === 'TEXTAREA') autoResizeTextarea(e.target);
                const toggleVisibility = (checkboxId, inputId) => {
                    if (e.target.id === checkboxId) {
                        const input = document.getElementById(inputId);
                        input.classList.toggle('hidden', !e.target.checked);
                        if (!e.target.checked) input.value = '';
                    }
                };
                toggleVisibility('checkbox-atestado', 'atestado-dias');
                toggleVisibility('checkbox-declaracao', 'declaracao-acompanhante');
                toggleVisibility('checkbox-laudo', 'laudo-opcoes');
                const data = coletarDadosDoFormulario();
                if (e.target.id === 'atual') data.isAISummary = false; 
                debouncedUpdate(data);
            });

            document.getElementById('paciente-nome').addEventListener('blur', (e) => {
                const target = e.target;
                target.value = target.value.replace(/\b\w/g, char => char.toUpperCase());
                debouncedUpdate();
                loadPatientRecord(target.value.trim());
            });

            document.getElementById('textarea-diagnosticos').addEventListener('blur', async (e) => {
                const ta = e.target;
                const initialText = ta.value.trim();
                if (!initialText || / \([A-Z]\d{1,2}(\.\d+)?\)$/m.test(initialText)) return;
                document.getElementById('cid-spinner').classList.remove('hidden');
                try {
                    const diagnosticosList = await separarDiagnosticosComIA(initialText);
                    const processedLines = await Promise.all(diagnosticosList.map(async (diag) => {
                        const trimmed = diag.trim();
                        if (!trimmed || /\s\([A-Z]\d{1,2}(\.\d+)?\)$/i.test(trimmed)) return trimmed;
                        const cid = await gerarCidComIA(trimmed);
                        return cid ? `${trimmed} (${cid})` : trimmed;
                    }));
                    const newText = processedLines.filter(Boolean).join('\n');
                    if (newText.trim() !== ta.value.trim()) {
                        ta.value = newText;
                        autoResizeTextarea(ta);
                        debouncedUpdate();
                    }
                } finally {
                    document.getElementById('cid-spinner').classList.add('hidden');
                }
            });

            document.getElementById('historia-inicial').addEventListener('blur', async (e) => {
                const histTA = e.target;
                const atualTA = document.getElementById('atual');
                if (!histTA.value.trim() || atualTA.value.trim()) return;
                document.getElementById('resumo-spinner').classList.remove('hidden');
                try {
                    const resumo = await gerarResumoComIA(histTA.value);
                    if (resumo) {
                        isProgrammaticChange = true;
                        atualTA.value = resumo;
                        autoResizeTextarea(atualTA);
                        isProgrammaticChange = false;
                        const data = coletarDadosDoFormulario();
                        data.isAISummary = true;
                        debouncedUpdate(data);
                    }
                } finally {
                     document.getElementById('resumo-spinner').classList.add('hidden');
                }
            });
            
            document.querySelectorAll('#form-container textarea').forEach(textarea => {
                textarea.addEventListener('blur', (e) => {
                    const el = e.target;
                    const textoOriginal = el.value;
                    const textoFormatado = formatarTextoCapitalizado(textoOriginal);
                    if (textoOriginal !== textoFormatado) {
                        el.value = textoFormatado;
                        debouncedUpdate();
                    }
                });
            });

            document.querySelectorAll('[data-toggle-container]').forEach(container => {
                container.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'BUTTON') return;
                    const isSim = e.target.dataset.value === 'sim';
                    container.querySelector('[data-value="sim"]').classList.toggle('active', isSim);
                    container.querySelector('[data-value="nao"]').classList.toggle('active', !isSim);
                    const detailIn = container.querySelector('input[type="text"]');
                    if (detailIn) detailIn.classList.toggle('hidden', !isSim);
                    debouncedUpdate();
                });
            });

            const setupTabs = (containerSelector, btnSelector, contentClass, onTabChange) => {
                document.querySelectorAll(`${containerSelector} ${btnSelector}`).forEach(button => {
                    button.addEventListener('click', () => {
                        const tabId = button.dataset.tabLeft || button.dataset.tab;

                        document.querySelectorAll(`.${contentClass}`).forEach(content => content.classList.remove('active'));
                        document.querySelectorAll(`${containerSelector} ${btnSelector}`).forEach(btn => btn.classList.remove('active'));

                        button.classList.add('active');
                        
                        let targetId = `tab-content-${tabId}`;
                        // CORREÇÃO: Lógica para encontrar o ID correto do conteúdo da aba
                        if (contentClass === 'tab-content-left' && tabId === 'historico') {
                            targetId = 'tab-content-historico';
                        }
                        
                        const targetElement = document.getElementById(targetId);

                        if (targetElement) {
                            targetElement.classList.add('active');
                        } else {
                            console.error(`Tab content with ID '${targetId}' was not found.`);
                        }

                        if (onTabChange) onTabChange(tabId);
                    });
                });
            };
            
            setupTabs('#left-column-tabs', '.tab-btn', 'tab-content-left', (tabId) => { if (tabId === 'historico') renderHistoricoTab(); });
            setupTabs('#right-column', '.tab-btn', 'tab-content');

            document.body.addEventListener('click', (e) => {
                const target = e.target;
                if (target.matches('#btn-copiar-evolucao')) {
                    salvarConsulta(); 
                    handleCopyClick(target, () => document.getElementById('evolucao-output').textContent);
                } else if (target.matches('#btn-copiar-todas-receitas')) {
                    const allRecipesText = gerarReceita(coletarDadosDoFormulario().conduta.terapiaMedicamentosa.map(t => t.texto).join('\n')).map(r => `--- ${r.title} ---\n${r.content}`).join('\n\n');
                    handleCopyClick(target, () => allRecipesText);
                } else if (target.matches('#btn-copiar-todos-documentos')) {
                    const allDocsText = gerarDocumentos().map(d => `--- ${d.title} ---\n${d.content}`).join('\n\n');
                    handleCopyClick(target, () => allDocsText);
                } else {
                    const copyItemBtn = target.closest('.btn-copy-item');
                    if (copyItemBtn) {
                        const pre = copyItemBtn.closest('.copy-container')?.querySelector('pre');
                        if (pre) handleCopyClick(copyItemBtn, () => pre.textContent);
                    }
                }
            });
            
            document.getElementById('btn-novo-paciente').addEventListener('click', resetApp);
            document.getElementById('textarea-informacoes').addEventListener('blur', analisarInformacoes);

            updateAllPreviews();
        });
    </script>
</body>
</html>


